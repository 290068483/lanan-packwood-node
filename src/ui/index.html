<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>客户数据打包管理系统</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #3498db;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }

      .control-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        margin-bottom: 15px;
        align-items: center;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .run-button {
        background-color: #27ae60;
      }

      .run-button:hover {
        background-color: #229954;
      }

      .stop-button {
        background-color: #e74c3c;
      }

      .stop-button:hover {
        background-color: #c0392b;
      }

      .path-config {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 3px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .path-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .path-label {
        width: 120px;
        font-weight: bold;
      }

      .path-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      /* 客户状态样式 */
      .status-not-packed {
        color: #95a5a6; /* 灰色 */
      }

      .status-in-progress {
        color: #3498db; /* 蓝色 */
      }

      .status-packed {
        color: #f1c40f; /* 黄色 */
      }

      .status-archived {
        color: #9b59b6; /* 紫色 */
      }

      .status-shipped {
        color: #2ecc71; /* 绿色 */
      }

      .status-not-shipped {
        color: #e67e22; /* 橙色 */
      }

      /* 操作按钮样式 */
      .action-btn {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .archive-btn {
        background-color: #9b59b6;
        color: white;
      }

      .archive-btn:hover {
        background-color: #8e44ad;
      }

      .ship-btn {
        background-color: #2ecc71;
        color: white;
      }

      .ship-btn:hover {
        background-color: #27ae60;
      }

      .not-shipped-btn {
        background-color: #e67e22;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #d35400;
      }

      .customers-table {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status-processing {
        color: #f39c12;
        font-weight: bold;
      }

      .status-completed {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .status-not-packed {
        color: #888888;
        font-weight: bold;
      }

      .status-in-progress {
        color: #2196f3;
        font-weight: bold;
      }

      .status-packed {
        color: #ffc107;
        font-weight: bold;
      }

      .status-archived {
        color: #9c27b0;
        font-weight: bold;
      }

      .status-shipped {
        color: #4caf50;
        font-weight: bold;
      }

      .status-not-shipped {
        color: #ff9800;
        font-weight: bold;
      }

      /* 进度条样式 */
      .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #333;
      }

      /* 操作按钮样式 */
      .action-cell {
        white-space: nowrap;
      }

      .action-btn {
        margin: 0 3px;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .archive-btn {
        background-color: #9c27b0;
        color: white;
      }

      .archive-btn:hover {
        background-color: #7b1fa2;
      }

      .ship-btn {
        background-color: #4caf50;
        color: white;
      }

      .ship-btn:hover {
        background-color: #388e3c;
      }

      .not-shipped-btn {
        background-color: #ff9800;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #f57c00;
      }

      .path-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: #7f8c8d;
        font-size: 12px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        color: white;
        background-color: #27ae60;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #27ae60;
      }

      .status-stopped {
        background-color: #e74c3c;
      }

      /* 配置区域样式 */
      .config-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .config-section:last-child {
        border-bottom: none;
      }

      .config-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      /* 模态框按钮区域 */
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* 配置按钮样式 */
      .config-button {
        background-color: #9b59b6;
      }

      .config-button:hover {
        background-color: #8e44ad;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* 处理状态显示 */
      .processing-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        background-color: #f8f9fa;
        display: none;
      }

      /* 数据库状态显示 */
      .db-status {
        display: flex;
        align-items: center;
        margin-left: auto;
        font-weight: bold;
      }

      .db-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .db-status-connected {
        background-color: #27ae60;
      }

      .db-status-disconnected {
        background-color: #e74c3c;
      }

      /* 同步状态显示 */
      .sync-status {
        display: flex;
        align-items: center;
        margin-left: 10px;
        font-weight: bold;
      }

      .sync-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .sync-status-idle {
        background-color: #95a5a6;
      }

      .sync-status-syncing {
        background-color: #3498db;
      }

      .sync-status-success {
        background-color: #27ae60;
      }

      .sync-status-error {
        background-color: #e74c3c;
      }

      /* 历史记录表格样式 */
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .history-table th,
      .history-table td {
        padding: 8px 12px;
        border: 1px solid #ddd;
        text-align: left;
      }

      .history-table th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      .history-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      .history-table tr:hover {
        background-color: #f1f1f1;
      }

      /* 归档详情样式 */
      .archive-detail {
        padding: 15px;
      }

      .info-section {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .info-section:last-child {
        border-bottom: none;
      }

      .info-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-item label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }

      .info-item.full-width {
        grid-column: 1 / -1;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 10px;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }

      .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
        font-style: italic;
      }

      /* 重新启动按钮样式 */
      .restart-button {
        background-color: #e67e22;
      }

      .restart-button:hover {
        background-color: #d35400;
      }

      /* 归档历史按钮样式 */
      .archive-button {
        background-color: #9b59b6;
      }

      .archive-button:hover {
        background-color: #8e44ad;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>客户数据打包管理系统</h1>
    </div>

    <div class="control-panel">
      <div class="button-group">
        <button id="syncDataBtn">同步数据源到数据库</button>
        <button id="refreshBtn">刷新数据</button>
        <button id="archiveHistoryBtn" class="archive-button">归档历史</button>
        <button id="restartBtn" class="restart-button">重新启动</button>
        <button id="configBtn" class="config-button">打开路径配置</button>
        <div id="syncStatus" class="sync-status">
          <span class="sync-status-indicator sync-status-idle"></span>
          <span>同步: 空闲</span>
        </div>
        <div id="dbStatus" class="db-status">
          <span class="db-status-indicator db-status-disconnected"></span>
          <span>数据库: 未连接</span>
        </div>
      </div>

      <div id="processingStatus" class="processing-status"></div>
    </div>

    <div class="customers-table">
      <h2 style="padding: 20px 20px 0 20px; text-align: center">
        客户信息和打包状态
      </h2>
      <table id="customersTable">
        <thead>
          <tr>
            <th>客户名称</th>
            <th>客户状态</th>
            <th>打包进度</th>
            <th>包号</th>
            <th>操作</th>
            <th>最后更新时间</th>
          </tr>
        </thead>
        <tbody>
          <!-- 数据将通过JavaScript动态填充 -->
        </tbody>
      </table>
    </div>
    <!-- 配置弹出层 -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>路径配置</h2>
        <form id="configForm">
          <div class="config-section">
            <h3>基本路径配置</h3>
            <div class="path-row">
              <span class="path-label">源地址:</span>
              <input
                type="text"
                id="sourcePathModal"
                class="path-input"
                placeholder="请输入源地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">输出地址:</span>
              <input
                type="text"
                id="outputPathModal"
                class="path-input"
                placeholder="请输入输出地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">网络路径:</span>
              <input
                type="text"
                id="networkPathModal"
                class="path-input"
                placeholder="网络同步路径（可选）"
              />
            </div>
          </div>
          <!-- <div class="config-section">
            <h3>打包数据路径</h3>
            <div class="path-row">
              <span class="path-label">客户已打包数据:</span>
              <input
                type="text"
                id="customerPackedPathModal"
                class="path-input"
                placeholder="客户已打包数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">工人打包数据:</span>
              <input
                type="text"
                id="workerPackagesPathModal"
                class="path-input"
                placeholder="工人打包数据路径"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>自动保存路径</h3>
            <div class="path-row">
              <span class="path-label">自动保存客户数据:</span>
              <input
                type="text"
                id="autoSaveCustomerPathModal"
                class="path-input"
                placeholder="自动保存客户数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">自动保存工人数据:</span>
              <input
                type="text"
                id="autoSaveWorkerPathModal"
                class="path-input"
                placeholder="自动保存工人数据路径"
              />
            </div>
          </div> -->
          <div class="modal-buttons">
            <button type="submit" id="saveModalConfigBtn">保存配置</button>
            <button type="button" id="cancelModalBtn">取消</button>
          </div>
        </form>
      </div>
    </div>
    <div class="notification" id="notification"></div>

    <div class="footer">
      <p>客户数据打包管理系统 v1.0</p>
    </div>

    <script>
      // 检查是否在 Electron 环境中运行
      const isElectron = !!window.electronAPI;

      // 全局变量
      let isRunning = false;
      let config = {};

      // 显示通知
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor =
          type === 'success' ? '#27ae60' : '#e74c3c';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // 显示处理状态
      function showProcessingStatus(message, type = 'info') {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = message;
        statusElement.style.display = 'block';

        // 根据类型设置背景色
        if (type === 'error') {
          statusElement.style.backgroundColor = '#f8d7da';
          statusElement.style.color = '#721c24';
          statusElement.style.borderColor = '#f5c6cb';
        } else if (type === 'info') {
          statusElement.style.backgroundColor = '#d1ecf1';
          statusElement.style.color = '#0c5460';
          statusElement.style.borderColor = '#bee5eb';
        } else {
          statusElement.style.backgroundColor = '#d4edda';
          statusElement.style.color = '#155724';
          statusElement.style.borderColor = '#c3e6cb';
        }
      }

      // 隐藏处理状态
      function hideProcessingStatus() {
        const statusElement = document.getElementById('processingStatus');
        statusElement.style.display = 'none';
      }

      // 更新数据库连接状态显示
      function updateDBStatus(isConnected) {
        const dbStatusElement = document.getElementById('dbStatus');
        const indicator = dbStatusElement.querySelector('.db-status-indicator');
        const text = dbStatusElement.querySelector('span:last-child');

        if (isConnected) {
          indicator.className = 'db-status-indicator db-status-connected';
          text.textContent = '数据库: 已连接';
        } else {
          indicator.className = 'db-status-indicator db-status-disconnected';
          text.textContent = '数据库: 未连接';
        }
      }

      // 更新同步状态显示
      function updateSyncStatus(status, message = '') {
        const syncStatusElement = document.getElementById('syncStatus');
        const indicator = syncStatusElement.querySelector(
          '.sync-status-indicator'
        );
        const text = syncStatusElement.querySelector('span:last-child');

        switch (status) {
          case 'idle':
            indicator.className = 'sync-status-indicator sync-status-idle';
            text.textContent = message || '同步: 空闲';
            break;
          case 'syncing':
            indicator.className = 'sync-status-indicator sync-status-syncing';
            text.textContent = message || '同步: 同步中...';
            break;
          case 'success':
            indicator.className = 'sync-status-indicator sync-status-success';
            text.textContent = message || '同步: 成功';
            break;
          case 'error':
            indicator.className = 'sync-status-indicator sync-status-error';
            text.textContent = message || '同步: 错误';
            break;
        }
      }

      // 检查数据库连接状态
      async function checkDatabaseConnection() {
        try {
          if (isElectron && window.electronAPI) {
            const isConnected =
              await window.electronAPI.checkDatabaseConnection();
            updateDBStatus(isConnected);
            return isConnected;
          } else {
            // 在非Electron环境中，默认为连接状态
            updateDBStatus(true);
            return true;
          }
        } catch (error) {
          console.error('检查数据库连接状态时出错:', error);
          updateDBStatus(false);
          return false;
        }
      }

      // 同步数据源到数据库
      async function syncDataSourceToDatabase() {
        try {
          updateSyncStatus('syncing', '同步: 正在同步...');

          if (isElectron && window.electronAPI) {
            // 调用主进程的同步功能
            await window.electronAPI.syncDataSource();
            updateSyncStatus('success', '同步: 成功');
            showNotification('数据同步成功');

            // 刷新客户数据
            await loadCustomers();
          }
        } catch (error) {
          console.error('同步数据时出错:', error);
          updateSyncStatus('error', '同步: 错误');
          showNotification('数据同步失败: ' + error.message, 'error');
        }

        // 3秒后恢复空闲状态
        setTimeout(() => {
          updateSyncStatus('idle');
        }, 3000);
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', async () => {
        // 检查数据库连接状态
        await checkDatabaseConnection();

        // 获取配置
        try {
          if (isElectron && window.electronAPI) {
            config = await window.electronAPI.getConfig();
          }
        } catch (error) {
          console.error('获取配置时出错:', error);
          showNotification('获取配置失败: ' + error.message, 'error');
        }

        // 绑定事件监听器
        document
          .getElementById('syncDataBtn')
          .addEventListener('click', syncDataSourceToDatabase);
        document
          .getElementById('refreshBtn')
          .addEventListener('click', refreshData);
        document
          .getElementById('archiveHistoryBtn')
          .addEventListener('click', showArchiveHistory);
        document
          .getElementById('restartBtn')
          .addEventListener('click', restartApplication);
        document
          .getElementById('configBtn')
          .addEventListener('click', openConfigModal);

        // 绑定模态框事件
        document
          .querySelector('#configModal .close')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('cancelModalBtn')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('configForm')
          .addEventListener('submit', saveConfig);

        // 点击模态框外部关闭模态框
        window.addEventListener('click', event => {
          const modal = document.getElementById('configModal');
          if (event.target === modal) {
            closeConfigModal();
          }
        });

        // 初始加载客户数据
        loadCustomers();

        // 检查状态按钮事件
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('check-status-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              let result;
              if (isElectron) {
                // Electron环境中调用检查功能
                result = await window.electronAPI.checkCustomerStatus(
                  customerName
                );
              } else {
                // Web环境中调用API
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(
                    customerName
                  )}/check-status`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                result = await response.json();
              }

              if (result.success) {
                showNotification(
                  `客户 ${customerName} 状态: ${result.status}, 打包进度: ${result.packProgress}%`,
                  'info'
                );
                // 刷新客户数据
                await loadCustomers();
              } else {
                showNotification(`检查状态失败: ${result.message}`, 'error');
              }
            } catch (error) {
              console.error('检查客户状态出错:', error);
              showNotification(`检查客户状态出错: ${error.message}`, 'error');
            }
          }

          // 处理'去处理'按钮点击事件
          if (event.target.classList.contains('process-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              if (isElectron) {
                // Electron环境中调用打开Excel文件功能
                await window.electronAPI.openCustomerExcelFile(customerName);
              } else {
                // Web环境中调用API获取Excel文件路径
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(
                    customerName
                  )}/open-excel`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                const result = await response.json();

                if (result.success) {
                  // 在Web模式下，我们提示用户手动打开文件
                  showNotification(
                    `请手动打开文件: ${result.filePath}`,
                    'info'
                  );
                } else {
                  showNotification(
                    `查找Excel文件失败: ${result.message}`,
                    'error'
                  );
                }
              }
            } catch (error) {
              console.error('打开Excel文件出错:', error);
              showNotification(`打开Excel文件出错: ${error.message}`, 'error');
            }
          }
        });
      });

      // 刷新数据
      async function refreshData() {
        showProcessingStatus('正在刷新数据...');
        try {
          await loadCustomers();
          showNotification('数据刷新成功');
        } catch (error) {
          console.error('刷新数据时出错:', error);
          showNotification('数据刷新失败: ' + error.message, 'error');
        } finally {
          hideProcessingStatus();
        }
      }

      // 加载客户数据
      async function loadCustomers() {
        try {
          let customers = [];
          if (isElectron && window.electronAPI) {
            customers = await window.electronAPI.getCustomers();
          }

          const tableBody = document.querySelector('#customersTable tbody');
          tableBody.innerHTML = '';

          customers.forEach(customer => {
            const row = document.createElement('tr');

            // 确定状态类名
            let statusClass = 'status-not-packed';
            switch (customer.status) {
              case '未打包':
                statusClass = 'status-not-packed';
                break;
              case '正在处理':
                statusClass = 'status-in-progress';
                break;
              case '已打包':
                statusClass = 'status-packed';
                break;
              case '已归档':
                statusClass = 'status-archived';
                break;
              case '已出货':
                statusClass = 'status-shipped';
                break;
              case '未出货':
                statusClass = 'status-not-shipped';
                break;
            }

            // 格式化最后更新时间
            const lastUpdate = customer.lastUpdate
              ? new Date(customer.lastUpdate).toLocaleString()
              : '无';

            // 操作按钮
            let actionButtons = '';
            if (customer.status === '未打包') {
              actionButtons = `
                <button class="action-btn process-btn" data-customer="${customer.name}">去处理</button>
              `;
            } else if (customer.status === '已打包') {
              actionButtons = `
                <button class="action-btn archive-btn" data-customer="${customer.name}">归档</button>
              `;
            } else if (customer.status === '已归档') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">出货</button>
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">标记为未出货</button>
              `;
            } else if (customer.status === '未出货') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">出货</button>
              `;
            }

            row.innerHTML = `
              <td>${customer.name}</td>
              <td class="${statusClass}">${customer.status}</td>
              <td>
                <div class="progress-container">
                  <div class="progress-bar" style="width: ${
                    customer.packProgress || 0
                  }%; background-color: #3498db;"></div>
                  <div class="progress-text">${
                    customer.packProgress || 0
                  }%</div>
                </div>
              </td>
              <td>${customer.packSeqs ? customer.packSeqs.join(', ') : ''}</td>
              <td class="action-cell">${actionButtons}</td>
              <td>${lastUpdate}</td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error('加载客户数据时出错:', error);
          showNotification('加载客户数据失败: ' + error.message, 'error');
        }
      }

      // 更新客户状态
      async function updateCustomerStatus(customerName, status) {
        try {
          if (isElectron && window.electronAPI) {
            await window.electronAPI.updateCustomerStatus(customerName, status);
            showNotification(`客户 ${customerName} 状态已更新为 ${status}`);
            await loadCustomers(); // 重新加载数据以显示更新
          }
        } catch (error) {
          console.error('更新客户状态时出错:', error);
          showNotification('状态更新失败: ' + error.message, 'error');
        }
      }

      // 打开配置模态框
      async function openConfigModal() {
        try {
          if (isElectron && window.electronAPI) {
            const currentConfig = await window.electronAPI.getConfig();
            document.getElementById('sourcePathModal').value =
              currentConfig.sourcePath || '';
            document.getElementById('outputPathModal').value =
              currentConfig.localPath || '';
            document.getElementById('networkPathModal').value =
              currentConfig.networkPath || '';
            document.getElementById('customerPackedPathModal').value =
              currentConfig.customerPackedPath || '';
            document.getElementById('workerPackagesPathModal').value =
              currentConfig.workerPackagesPath || '';
            document.getElementById('autoSaveCustomerPathModal').value =
              currentConfig.autoSaveCustomerPath || '';
            document.getElementById('autoSaveWorkerPathModal').value =
              currentConfig.autoSaveWorkerPath || '';
          }
          document.getElementById('configModal').style.display = 'block';
        } catch (error) {
          console.error('打开配置模态框时出错:', error);
          showNotification('打开配置失败: ' + error.message, 'error');
        }
      }

      // 关闭配置模态框
      function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
      }

      // 重新启动应用程序
      async function restartApplication() {
        try {
          showProcessingStatus('正在重新启动应用程序...');
          
          if (isElectron && window.electronAPI) {
            // Electron环境中请求重新启动
            await window.electronAPI.restartApplication();
            showNotification('应用程序正在重新启动...');
          } else {
            // Web环境中提示用户手动刷新页面
            showNotification('请手动刷新页面以重新启动应用程序', 'info');
            // 延迟后刷新页面
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          }
        } catch (error) {
          console.error('重新启动应用程序时出错:', error);
          showNotification('重新启动失败: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // 显示归档历史
      async function showArchiveHistory(page = 1, pageSize = 20) {
        try {
          showProcessingStatus('正在加载归档历史...');
          
          let archives = [];
          if (isElectron && window.electronAPI) {
            // Electron环境中获取归档列表
            const response = await window.electronAPI.getArchiveList(page, pageSize);
            if (response.success) {
              archives = response.data;
            }
          }
          
          // 创建归档历史模态框
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>归档历史</h2>
              <div id="archiveHistoryContent">
                ${archives.length > 0 ? 
                  `<table class="history-table">
                    <thead>
                      <tr>
                        <th>客户名称</th>
                        <th>归档日期</th>
                        <th>包数量</th>
                        <th>板件总数</th>
                        <th>操作员</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${archives.map(archive => `
                        <tr>
                          <td>${archive.customer_name || '未知'}</td>
                          <td>${archive.archive_date ? new Date(archive.archive_date).toLocaleString() : '未知'}</td>
                          <td>${archive.packages_count || 0}</td>
                          <td>${archive.total_parts_count || 0}</td>
                          <td>${archive.archive_user || '未知'}</td>
                          <td>
                            <button class="action-btn view-archive-btn" data-id="${archive.id}">查看详情</button>
                            <button class="action-btn restore-archive-btn" data-id="${archive.id}">恢复</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>` : 
                  `<p>暂无归档数据</p>`}
              </div>
              <div class="modal-buttons">
                <button type="button" id="closeArchiveHistoryBtn">关闭</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          modal.style.display = 'block';
          showProcessingStatus('');
          
          // 绑定关闭按钮事件
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });
          
          modal.querySelector('#closeArchiveHistoryBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
          });
          
          // 点击模态框外部关闭
          window.addEventListener('click', (event) => {
            if (event.target === modal) {
              document.body.removeChild(modal);
            }
          });
          
          // 添加查看详情按钮事件
          modal.querySelectorAll('.view-archive-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const archiveId = btn.getAttribute('data-id');
              await showArchiveDetail(archiveId);
            });
          });
          
          // 添加恢复按钮事件
          modal.querySelectorAll('.restore-archive-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const archiveId = btn.getAttribute('data-id');
              await confirmRestoreArchive(archiveId);
            });
          });
        } catch (error) {
          console.error('获取归档历史时出错:', error);
          showNotification('获取归档历史失败: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // 显示归档详情
      async function showArchiveDetail(archiveId) {
        try {
          showProcessingStatus('正在加载归档详情...');

          let archive = null;
          if (isElectron && window.electronAPI) {
            // Electron环境中获取归档详情
            const response = await window.electronAPI.getArchiveDetail(archiveId);
            if (response.success) {
              archive = response.data;
            }
          }

          if (!archive) {
            showNotification('归档不存在', 'error');
            return;
          }

          // 创建归档详情模态框
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>客户归档详情</h2>
              <div class="archive-detail">
                <div class="info-section">
                  <h3>基本信息</h3>
                  <div class="info-grid">
                    <div class="info-item">
                      <label>客户名称:</label>
                      <span>${archive.customer_name || '未知'}</span>
                    </div>
                    <div class="info-item">
                      <label>归档日期:</label>
                      <span>${archive.archive_date ? new Date(archive.archive_date).toLocaleString() : '未知'}</span>
                    </div>
                    <div class="info-item">
                      <label>包数量:</label>
                      <span>${archive.packages_count || 0}</span>
                    </div>
                    <div class="info-item">
                      <label>板件总数:</label>
                      <span>${archive.total_parts_count || 0}</span>
                    </div>
                    <div class="info-item">
                      <label>操作员:</label>
                      <span>${archive.archive_user || '未知'}</span>
                    </div>
                    <div class="info-item">
                      <label>归档ID:</label>
                      <span>${archive.id || '未知'}</span>
                    </div>
                  </div>
                </div>
                
                <div class="info-section">
                  <h3>包信息</h3>
                  ${
                    archive.packages && archive.packages.length > 0 ?
                    `<div class="table-container">
                      <table class="history-table">
                        <thead>
                          <tr>
                            <th>包号</th>
                            <th>板件数量</th>
                            <th>文件路径</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${archive.packages.map(pkg => `
                            <tr>
                              <td>${pkg.package_id || '未知'}</td>
                              <td>${pkg.parts_count || 0}</td>
                              <td>${pkg.file_path || '未知'}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>` :
                    `<p class="no-data">暂无包信息</p>`
                  }
                </div>
                
                <div class="info-section">
                  <h3>XML文件</h3>
                  ${
                    archive.xml_files && archive.xml_files.length > 0 ?
                    `<div class="table-container">
                      <table class="history-table">
                        <thead>
                          <tr>
                            <th>文件名</th>
                            <th>文件路径</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${archive.xml_files.map(file => `
                            <tr>
                              <td>${file.name || '未知'}</td>
                              <td>${file.path || '未知'}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>` :
                    `<p class="no-data">暂无XML文件</p>`
                  }
                </div>
              </div>
              <div class="modal-buttons">
                <button type="button" id="closeDetailBtn">关闭</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          modal.style.display = 'block';
          showProcessingStatus('');

          // 绑定关闭按钮事件
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });

          modal.querySelector('#closeDetailBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
          });

          // 点击模态框外部关闭
          window.addEventListener('click', (event) => {
            if (event.target === modal) {
              document.body.removeChild(modal);
            }
          });
        } catch (error) {
          console.error('获取归档详情时出错:', error);
          showNotification('获取归档详情失败: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // 确认恢复归档
      async function confirmRestoreArchive(archiveId) {
        try {
          // 创建确认模态框
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>确认恢复归档</h2>
              <p>您确定要恢复此归档吗？这将把归档数据恢复到客户目录中。</p>
              <div class="modal-buttons">
                <button type="button" id="cancel-restore-btn">取消</button>
                <button type="button" id="confirm-restore-btn" style="background-color: #e74c3c;">确认恢复</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          modal.style.display = 'block';
          
          // 绑定关闭按钮事件
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });
          
          // 取消按钮事件
          document
            .getElementById('cancel-restore-btn')
            .addEventListener('click', () => {
              document.body.removeChild(modal);
            });
          
          // 确认按钮事件
          document
            .getElementById('confirm-restore-btn')
            .addEventListener('click', async () => {
              document.body.removeChild(modal);
              
              try {
                showProcessingStatus('正在恢复归档...');
                
                let result = { success: false };
                if (isElectron && window.electronAPI) {
                  // Electron环境中恢复归档
                  result = await window.electronAPI.restoreArchive(archiveId);
                  
                  if (result.success) {
                    showNotification(result.message || '归档恢复成功');
                    // 刷新客户数据
                    await loadCustomers();
                  } else {
                    showNotification(result.message || '归档恢复失败', 'error');
                  }
                }
                
                showProcessingStatus('');
              } catch (error) {
                console.error('恢复归档时出错:', error);
                showNotification('恢复归档失败: ' + error.message, 'error');
                showProcessingStatus('');
              }
            });
        } catch (error) {
          console.error('确认恢复归档时出错:', error);
          showNotification('确认恢复归档失败: ' + error.message, 'error');
        }
      }

      // 导出归档数据到Excel
      async function exportArchiveToExcel(archiveId) {
        try {
          showProcessingStatus('正在导出Excel...');
          
          let result = { success: false };
          if (isElectron && window.electronAPI) {
            // Electron环境中导出Excel
            result = await window.electronAPI.exportArchiveToExcel(archiveId);
          }
          
          if (result.success) {
            showNotification(`Excel文件已导出到: ${result.filePath}`);
          } else {
            showNotification(result.message || '导出Excel失败', 'error');
          }
          
          showProcessingStatus('');
        } catch (error) {
          console.error('导出Excel时出错:', error);
          showNotification('导出Excel失败: ' + error.message, 'error');
          showProcessingStatus('');
        }
      }

      // 导出归档数据到PDF
      async function exportArchiveToPDF(archiveId) {
        try {
          showProcessingStatus('正在导出PDF...');
          
          let result = { success: false };
          if (isElectron && window.electronAPI) {
            // Electron环境中导出PDF
            result = await window.electronAPI.exportArchiveToPDF(archiveId);
          }
          
          if (result.success) {
            showNotification(`PDF文件已导出到: ${result.filePath}`);
          } else {
            showNotification(result.message || '导出PDF失败', 'error');
          }
          
          showProcessingStatus('');
        } catch (error) {
          console.error('导出PDF时出错:', error);
          showNotification('导出PDF失败: ' + error.message, 'error');
          showProcessingStatus('');
        }
      }

      // 保存配置
      async function saveConfig(event) {
        event.preventDefault();
        try {
          const newConfig = {
            sourcePath: document.getElementById('sourcePathModal').value,
            localPath: document.getElementById('outputPathModal').value,
            networkPath: document.getElementById('networkPathModal').value,
            customerPackedPath: document.getElementById(
              'customerPackedPathModal'
            ).value,
            workerPackagesPath: document.getElementById(
              'workerPackagesPathModal'
            ).value,
            autoSaveCustomerPath: document.getElementById(
              'autoSaveCustomerPathModal'
            ).value,
            autoSaveWorkerPath: document.getElementById(
              'autoSaveWorkerPathModal'
            ).value,
          };

          if (isElectron && window.electronAPI) {
            await window.electronAPI.saveConfig(newConfig);
            config = newConfig;
            showNotification('配置保存成功');
            closeConfigModal();
          }
        } catch (error) {
          console.error('保存配置时出错:', error);
          showNotification('配置保存失败: ' + error.message, 'error');
        }
      }
    </script>
  </body>
</html>