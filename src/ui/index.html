<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>客户数据打包管理系统</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #3498db;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }

      .control-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .run-button {
        background-color: #27ae60;
      }

      .run-button:hover {
        background-color: #229954;
      }

      .stop-button {
        background-color: #e74c3c;
      }

      .stop-button:hover {
        background-color: #c0392b;
      }

      .path-config {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 3px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .path-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .path-label {
        width: 120px;
        font-weight: bold;
      }

      .path-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      .customers-table {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status-processing {
        color: #f39c12;
        font-weight: bold;
      }

      .status-completed {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .path-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: #7f8c8d;
        font-size: 12px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        color: white;
        background-color: #27ae60;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #27ae60;
      }

      .status-stopped {
        background-color: #e74c3c;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      /* 配置区域样式 */
      .config-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .config-section:last-child {
        border-bottom: none;
      }

      .config-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      /* 模态框按钮区域 */
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* 配置按钮样式 */
      .config-button {
        background-color: #9b59b6;
      }

      .config-button:hover {
        background-color: #8e44ad;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      
      /* 处理状态显示 */
      .processing-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        background-color: #f8f9fa;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>客户数据打包管理系统</h1>
    </div>

    <div class="control-panel">
      <h2>打开文件路径</h2>
      <div class="button-group">
        <button
          id="viewDataBtn"
          title="查看自动保存数据的存储位置"
        >
          查看自动保存路径
        </button>
        <button id="refreshBtn">刷新数据</button>
        <label class="auto-save-toggle">
          自动保存:
          <input type="checkbox" id="autoSaveToggle" checked />
        </label>
      </div>

      <div class="button-group">
        <button id="runBtn" class="run-button">运行</button>
        <button id="stopBtn" class="stop-button" disabled>停止运行</button>
        <span id="statusIndicator">
          <span class="status-indicator status-stopped"></span>
          <span>已停止</span>
        </span>
      </div>
      
      <div id="processingStatus" class="processing-status"></div>

      <div>
        <button id="configBtn" class="config-button">打开路径配置</button>
      </div>
    </div>

    <div class="customers-table">
      <h2 style="padding: 20px 20px 0 20px; text-align: center">
        客户信息和打包状态
      </h2>
      <table id="customersTable">
        <thead>
          <tr>
            <th>客户名称</th>
            <th>源地址</th>
            <th>输出地址</th>
            <th>打包状态</th>
            <th>最后更新时间</th>
          </tr>
        </thead>
        <tbody>
          <!-- 数据将通过JavaScript动态填充 -->
        </tbody>
      </table>
    </div>
    <!-- 配置弹出层 -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>路径配置</h2>
        <form id="configForm">
          <div class="config-section">
            <h3>基本路径配置</h3>
            <div class="path-row">
              <span class="path-label">源地址:</span>
              <input
                type="text"
                id="sourcePathModal"
                class="path-input"
                placeholder="请输入源地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">输出地址:</span>
              <input
                type="text"
                id="outputPathModal"
                class="path-input"
                placeholder="请输入输出地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">网络路径:</span>
              <input
                type="text"
                id="networkPathModal"
                class="path-input"
                placeholder="网络同步路径（可选）"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>打包数据路径</h3>
            <div class="path-row">
              <span class="path-label">客户已打包数据:</span>
              <input
                type="text"
                id="customerPackedPathModal"
                class="path-input"
                placeholder="客户已打包数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">工人打包数据:</span>
              <input
                type="text"
                id="workerPackagesPathModal"
                class="path-input"
                placeholder="工人打包数据路径"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>自动保存路径</h3>
            <div class="path-row">
              <span class="path-label">自动保存客户数据:</span>
              <input
                type="text"
                id="autoSaveCustomerPathModal"
                class="path-input"
                placeholder="自动保存客户数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">自动保存工人数据:</span>
              <input
                type="text"
                id="autoSaveWorkerPathModal"
                class="path-input"
                placeholder="自动保存工人数据路径"
              />
            </div>
          </div>
          <div class="modal-buttons">
            <button type="submit" id="saveModalConfigBtn">保存配置</button>
            <button type="button" id="cancelModalBtn">取消</button>
          </div>
        </form>
      </div>
    </div>
    <div class="notification" id="notification"></div>

    <div class="footer">
      <p>客户数据打包管理系统 v1.0</p>
    </div>

    <script>
      // 检查是否在 Electron 环境中运行
      const isElectron = !!window.electronAPI;
      
      // 全局变量
      let isRunning = false;
      let config = {};

      // 显示通知
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor =
          type === 'success' ? '#27ae60' : '#e74c3c';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }
      
      // 显示处理状态
      function showProcessingStatus(message, type = 'info') {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = message;
        statusElement.style.display = 'block';
        
        // 根据类型设置背景色
        switch (type) {
          case 'error':
            statusElement.style.backgroundColor = '#fceaea';
            statusElement.style.color = '#c0392b';
            break;
          case 'success':
            statusElement.style.backgroundColor = '#eafaf1';
            statusElement.style.color = '#27ae60';
            break;
          default:
            statusElement.style.backgroundColor = '#f8f9fa';
            statusElement.style.color = '#333';
        }
      }
      
      // 隐藏处理状态
      function hideProcessingStatus() {
        const statusElement = document.getElementById('processingStatus');
        statusElement.style.display = 'none';
      }

      // 查看自动保存路径按钮点击事件
      async function viewDataBtnClick() {
        try {
          // 确保获取最新配置
          if (!config || Object.keys(config).length === 0) {
            await loadConfigToModal();
          }
          
          const path = config.customerPackedPath;
          if (!path) {
            showNotification('未配置自动保存路径', 'error');
            return;
          }
          
          if (isElectron) {
            // 在 Electron 环境中打开路径
            const result = await window.electronAPI.openDirectory(path);
            if (result.success) {
              showNotification('已成功打开文件夹: ' + abbreviatePath(path), 'success');
            } else {
              showNotification('打开文件夹失败: ' + result.error, 'error');
            }
          } else {
            // Web 环境中通过服务器打开路径
            showNotification('正在打开路径: ' + abbreviatePath(path));
            const response = await fetch('/open-folder?path=' + encodeURIComponent(path));
            const result = await response.text();
            
            if (response.ok) {
              showNotification('已成功打开文件夹: ' + abbreviatePath(path), 'success');
            } else {
              showNotification('打开文件夹失败: ' + result, 'error');
            }
          }
        } catch (error) {
          console.error('打开路径出错:', error);
          showNotification('打开路径出错: ' + error.message, 'error');
        }
      }

      // 刷新数据按钮点击事件
      async function refreshBtnClick() {
        await loadCustomers();
        showNotification('数据已刷新');
      }

      // 更新运行状态显示
      function updateRunStatus(running) {
        isRunning = running;
        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusIndicator = document.getElementById('statusIndicator');

        runBtn.disabled = isRunning;
        stopBtn.disabled = !isRunning;

        if (isRunning) {
          statusIndicator.innerHTML =
            '<span class="status-indicator status-running"></span><span>运行中</span>';
        } else {
          statusIndicator.innerHTML =
            '<span class="status-indicator status-stopped"></span><span>已停止</span>';
        }
      }

      // 检查路径配置
      function checkPaths() {
        const sourcePath = document
          .getElementById('sourcePathModal')
          .value.trim();
        const outputPath = document
          .getElementById('outputPathModal')
          .value.trim();

        if (!sourcePath || !outputPath) {
          showNotification('请先配置源地址和输出地址', 'error');
          return false;
        }

        return true;
      }

      // 加载配置到弹出层表单
      async function loadConfigToModal() {
        try {
          if (isElectron) {
            config = await window.electronAPI.getConfig();
          } else {
            const response = await fetch('/api/config');
            if (response.ok) {
              config = await response.json();
            } else {
              showNotification('加载配置失败', 'error');
              return;
            }
          }
          
          document.getElementById('sourcePathModal').value =
            config.sourcePath || '';
          document.getElementById('outputPathModal').value =
            config.localPath || '';
          document.getElementById('networkPathModal').value =
            config.networkPath || '';
          document.getElementById('customerPackedPathModal').value =
            config.customerPackedPath || '';
          document.getElementById('workerPackagesPathModal').value =
            config.workerPackagesPath || '';
          // 添加新的自动保存路径配置项
          document.getElementById('autoSaveCustomerPathModal').value =
            config.autoSaveCustomerPath || '';
          document.getElementById('autoSaveWorkerPathModal').value =
            config.autoSaveWorkerPath || '';
        } catch (error) {
          console.error('加载配置出错:', error);
          showNotification('加载配置出错: ' + error.message, 'error');
        }
      }

      // 获取运行状态
      async function getRunStatus() {
        // 在Electron环境中，运行状态由UI控制
        if (!isElectron) {
          try {
            const response = await fetch('/api/status');
            if (response.ok) {
              const status = await response.json();
              updateRunStatus(status.running);
            }
          } catch (error) {
            console.error('获取运行状态出错:', error);
          }
        }
      }

      // 开始运行主程序
      async function startRun() {
        if (!checkPaths()) {
          return;
        }

        try {
          if (isElectron) {
            // 使用 Electron IPC 启动处理
            updateRunStatus(true);
            showProcessingStatus('正在启动处理程序...');
            
            const result = await window.electronAPI.startProcessing();
            if (result.success) {
              showNotification(result.message || '程序开始运行');
              showProcessingStatus('处理完成: 成功处理 ' + result.result.successCount + ' 个客户', 'success');
            } else {
              showNotification('启动失败: ' + (result.error || '未知错误'), 'error');
              showProcessingStatus('处理失败: ' + (result.error || '未知错误'), 'error');
              updateRunStatus(false);
            }
          } else {
            const response = await fetch('/api/run', {
              method: 'POST',
            });

            if (response.ok) {
              const result = await response.json();
              showNotification(result.message || '程序开始运行');
              updateRunStatus(true);
            } else {
              const result = await response.json();
              showNotification(
                '启动失败: ' + (result.error || '未知错误'),
                'error'
              );
            }
          }
        } catch (error) {
          console.error('启动程序出错:', error);
          showNotification('启动程序出错: ' + error.message, 'error');
          if (isElectron) {
            showProcessingStatus('启动程序出错: ' + error.message, 'error');
            updateRunStatus(false);
          }
        }
      }

      // 停止运行主程序
      async function stopRun() {
        try {
          if (isElectron) {
            // 使用 Electron IPC 停止处理
            const result = await window.electronAPI.stopProcessing();
            if (result.success) {
              showNotification(result.message || '程序已停止');
              updateRunStatus(false);
              hideProcessingStatus();
            } else {
              showNotification('停止失败: ' + (result.error || '未知错误'), 'error');
            }
          } else {
            const response = await fetch('/api/stop', {
              method: 'POST',
            });

            if (response.ok) {
              const result = await response.json();
              showNotification(result.message || '程序已停止');
              updateRunStatus(false);
            } else {
              const result = await response.json();
              showNotification(
                '停止失败: ' + (result.error || '未知错误'),
                'error'
              );
            }
          }
        } catch (error) {
          console.error('停止程序出错:', error);
          showNotification('停止程序出错: ' + error.message, 'error');
        }
      }

      // 页面加载完成后获取客户数据
      document.addEventListener('DOMContentLoaded', async () => {
        await loadCustomers();
        await loadConfigToModal();
        await getRunStatus();
        
        // 在Electron环境中注册事件监听器
        if (isElectron) {
          // 监听处理状态更新
          window.electronAPI.onProcessingStatus((data) => {
            switch (data.status) {
              case 'started':
                updateRunStatus(true);
                showProcessingStatus('处理程序已启动...');
                break;
              case 'completed':
                updateRunStatus(false);
                showProcessingStatus('处理完成: 成功处理 ' + data.result.successCount + ' 个客户', 'success');
                // 刷新客户数据
                loadCustomers();
                break;
              case 'error':
                updateRunStatus(false);
                showProcessingStatus('处理出错: ' + data.error, 'error');
                break;
              case 'stopped':
                updateRunStatus(false);
                hideProcessingStatus();
                break;
            }
          });
          
          // 监听未捕获的异常
          window.electronAPI.onUncaughtError((data) => {
            console.error('未捕获的异常:', data);
            showNotification('程序出错: ' + data.message, 'error');
          });
          
          // 监听未处理的Promise拒绝
          window.electronAPI.onUnhandledRejection((data) => {
            console.error('未处理的Promise拒绝:', data);
            showNotification('程序出错: ' + data.reason, 'error');
          });
        }
      });

      // 刷新按钮事件
      document
        .getElementById('refreshBtn')
        .addEventListener('click', async () => {
          await loadCustomers();
          showNotification('数据已刷新');
        });

      // 运行按钮事件
      document.getElementById('runBtn').addEventListener('click', startRun);

      // 停止按钮事件
      document.getElementById('stopBtn').addEventListener('click', stopRun);

      // 加载客户数据
      async function loadCustomers() {
        try {
          let customers;
          if (isElectron) {
            // 使用 Electron IPC 获取客户数据
            customers = await window.electronAPI.getCustomers();
          } else {
            const response = await fetch('/api/customers');
            customers = await response.json();
          }
          
          const tbody = document.querySelector('#customersTable tbody');
          tbody.innerHTML = '';

          if (customers.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td colspan="6" style="text-align: center; font-style: italic; color: #7f8c8d;">
                            暂无客户数据
                        </td>
                    `;
            tbody.appendChild(row);
            return;
          }

          customers.forEach(customer => {
            const row = document.createElement('tr');
            const lastUpdate = customer.lastUpdate
              ? new Date(customer.lastUpdate).toLocaleDateString()
              : '未知';

            // 状态样式处理
            let statusClass = '';
            switch (customer.status) {
              case '已处理':
              case '已完成':
                statusClass = 'status-completed';
                break;
              case '处理中':
              case '进行中':
                statusClass = 'status-processing';
                break;
              case '处理失败':
              case '错误':
                statusClass = 'status-error';
                break;
            }

            row.innerHTML = `
                        <td>${customer.name || ''}</td>
                        <td class="path-cell" title="${
                          customer.sourcePath || ''
                        }">${abbreviatePath(customer.sourcePath) || ''}</td>
                        <td class="path-cell" title="${
                          customer.outputPath || ''
                        }">${abbreviatePath(customer.outputPath) || ''}</td>
                        <td class="${statusClass}">${
              customer.status || '未知'
            }</td>
                        <td>${lastUpdate}</td>
                    `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('加载客户数据失败:', error);
          showNotification('加载数据失败: ' + error.message, 'error');
        }
      }

      // 缩短路径显示
      function abbreviatePath(fullPath) {
        if (!fullPath) return '';

        // 只显示路径的最后两个部分
        const parts = fullPath.split(/[/\\]/);
        if (parts.length <= 2) {
          return fullPath;
        }
        return `...${parts[parts.length - 2]}/${parts[parts.length - 1]}`;
      }

      // 弹出层相关逻辑
      document
        .getElementById('configBtn')
        .addEventListener('click', function () {
          // 打开弹出层前，先加载当前配置到弹出层表单
          loadConfigToModal();
          document.getElementById('configModal').style.display = 'block';
        });

      document.querySelector('.close').addEventListener('click', function () {
        document.getElementById('configModal').style.display = 'none';
      });

      // 取消按钮事件
      document
        .getElementById('cancelModalBtn')
        .addEventListener('click', function () {
          document.getElementById('configModal').style.display = 'none';
        });

      window.onclick = function (event) {
        const modal = document.getElementById('configModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };

      // 配置表单提交事件
      document
        .getElementById('configForm')
        .addEventListener('submit', function (e) {
          e.preventDefault();
          saveModalConfig();
        });

      // 保存弹出层中的配置
      async function saveModalConfig() {
        try {
          // 添加保存确认提示
          if (!confirm('确定要保存当前配置吗？')) {
            showNotification('保存操作已取消');
            return;
          }

          const newConfig = {
            sourcePath: document.getElementById('sourcePathModal').value.trim(),
            localPath: document.getElementById('outputPathModal').value.trim(),
            networkPath: document
              .getElementById('networkPathModal')
              .value.trim(),
            customerPackedPath: document
              .getElementById('customerPackedPathModal')
              .value.trim(),
            workerPackagesPath: document
              .getElementById('workerPackagesPathModal')
              .value.trim(),
            autoSaveCustomerPath: document
              .getElementById('autoSaveCustomerPathModal')
              .value.trim(),
            autoSaveWorkerPath: document
              .getElementById('autoSaveWorkerPathModal')
              .value.trim()
          };

          let result;
          if (isElectron) {
            result = await window.electronAPI.saveConfig(newConfig);
          } else {
            const response = await fetch('/api/config', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(newConfig),
            });
            result = await response.json();
          }

          if (result.success) {
            showNotification('配置已保存');
            document.getElementById('configModal').style.display = 'none';
          } else {
            showNotification(
              '保存配置失败: ' + (result.error || '未知错误'),
              'error'
            );
          }
        } catch (error) {
          console.error('保存配置出错:', error);
          showNotification('保存配置出错: ' + error.message, 'error');
        }
      }

      // 自动保存开关功能
      let autoSaveEnabled = true;
      const autoSaveToggle = document.getElementById('autoSaveToggle');

      // 初始化自动保存状态
      autoSaveEnabled = autoSaveToggle.checked;

      // 添加自动保存开关事件监听器
      autoSaveToggle.addEventListener('change', function () {
        autoSaveEnabled = this.checked;
        showNotification(
          autoSaveEnabled ? '自动保存功能已开启' : '自动保存功能已关闭'
        );

        // 可以在这里添加与自动保存相关的逻辑
        // 例如，如果关闭自动保存，可以清除相关的定时器等
      });

      // 按钮事件处理
      document.getElementById('viewDataBtn').addEventListener('click', async function () {
        try {
          // 确保获取最新配置
          if (!config || Object.keys(config).length === 0) {
            await loadConfigToModal();
          }
          
          // 从配置中获取保存路径
          const workerBackupPath = config.workerPackagesPath || 'D:/backup_data/backup/backup/worker';
          const customerBackupPath = config.customerPackedPath || 'D:/backup_data/backup/backup/customer';

          // 创建一个简单的选择对话框
          const dialog = document.createElement('div');
          dialog.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
          `;
          
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
          `;
          
          const title = document.createElement('h3');
          title.textContent = '请选择要打开的文件夹';
          dialog.appendChild(title);
          
          const btn1 = document.createElement('button');
          btn1.textContent = '客户数据文件路径';
          btn1.style.cssText = 'margin: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;';
          btn1.onclick = async function() {
            // 在 Electron 环境中打开客户数据文件路径
            if (isElectron) {
              const result = await window.electronAPI.openDirectory(customerBackupPath);
              if (result.success) {
                showNotification('已成功打开文件夹: ' + abbreviatePath(customerBackupPath), 'success');
              } else {
                showNotification('打开文件夹失败: ' + result.error, 'error');
              }
              document.body.removeChild(dialog);
              document.body.removeChild(overlay);
            } else {
              // 发送请求到服务器打开客户数据文件路径
              try {
                const response = await fetch('/open-folder?path=' + encodeURIComponent(customerBackupPath));
                const message = await response.text();
                
                if (response.ok) {
                  showNotification(message);
                } else {
                  showNotification('打开文件夹失败: ' + message, 'error');
                }
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              } catch (err) {
                showNotification('无法打开文件夹：' + err.message, 'error');
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              }
            }
          };
          dialog.appendChild(btn1);
          
          const btn2 = document.createElement('button');
          btn2.textContent = '工人打包文件路径';
          btn2.style.cssText = 'margin: 10px; padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;';
          btn2.onclick = async function() {
            // 在 Electron 环境中打开工人打包文件路径
            if (isElectron) {
              const result = await window.electronAPI.openDirectory(workerBackupPath);
              if (result.success) {
                showNotification('已成功打开文件夹: ' + abbreviatePath(workerBackupPath), 'success');
              } else {
                showNotification('打开文件夹失败: ' + result.error, 'error');
              }
              document.body.removeChild(dialog);
              document.body.removeChild(overlay);
            } else {
              // 发送请求到服务器打开工人打包文件路径
              try {
                const response = await fetch('/open-folder?path=' + encodeURIComponent(workerBackupPath));
                const message = await response.text();
                
                if (response.ok) {
                  showNotification(message);
                } else {
                  showNotification('打开文件夹失败: ' + message, 'error');
                }
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              } catch (err) {
                showNotification('无法打开文件夹：' + err.message, 'error');
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              }
            }
          };
          dialog.appendChild(btn2);
          
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = '取消';
          cancelBtn.style.cssText = 'margin: 10px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;';
          cancelBtn.onclick = function() {
            document.body.removeChild(dialog);
            document.body.removeChild(overlay);
          };
          dialog.appendChild(cancelBtn);
          
          document.body.appendChild(overlay);
          document.body.appendChild(dialog);
        } catch (error) {
          console.error('打开路径出错:', error);
          showNotification('打开路径出错: ' + error.message, 'error');
        }
      });
    </script>
  </body>
</html>