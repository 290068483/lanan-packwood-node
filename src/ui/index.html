<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>客户数据打包管理系统</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #3498db;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }

      .control-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        margin-bottom: 15px;
        align-items: center;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .run-button {
        background-color: #27ae60;
      }

      .run-button:hover {
        background-color: #229954;
      }

      .stop-button {
        background-color: #e74c3c;
      }

      .stop-button:hover {
        background-color: #c0392b;
      }

      .path-config {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 3px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .path-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .path-label {
        width: 120px;
        font-weight: bold;
      }

      .path-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      /* 客户状态样式 */
      .status-not-packed {
        color: #95a5a6; /* 灰色 */
      }

      .status-in-progress {
        color: #3498db; /* 蓝色 */
      }

      .status-packed {
        color: #f1c40f; /* 黄色 */
      }

      .status-archived {
        color: #9b59b6; /* 紫色 */
      }

      .status-shipped {
        color: #2ecc71; /* 绿色 */
      }

      .status-not-shipped {
        color: #e67e22; /* 橙色 */
      }

      /* 操作按钮样式 */
      .action-btn {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .archive-btn {
        background-color: #9b59b6;
        color: white;
      }

      .archive-btn:hover {
        background-color: #8e44ad;
      }

      .ship-btn {
        background-color: #2ecc71;
        color: white;
      }

      .ship-btn:hover {
        background-color: #27ae60;
      }

      .not-shipped-btn {
        background-color: #e67e22;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #d35400;
      }

      .customers-table {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status-processing {
        color: #f39c12;
        font-weight: bold;
      }

      .status-completed {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .status-not-packed {
        color: #888888;
        font-weight: bold;
      }

      .status-in-progress {
        color: #2196f3;
        font-weight: bold;
      }

      .status-packed {
        color: #ffc107;
        font-weight: bold;
      }

      .status-archived {
        color: #9c27b0;
        font-weight: bold;
      }

      .status-shipped {
        color: #4caf50;
        font-weight: bold;
      }

      .status-not-shipped {
        color: #ff9800;
        font-weight: bold;
      }

      /* 进度条样式 */
      .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #333;
      }

      /* 操作按钮样式 */
      .action-cell {
        white-space: nowrap;
      }

      .action-btn {
        margin: 0 3px;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .archive-btn {
        background-color: #9c27b0;
        color: white;
      }

      .archive-btn:hover {
        background-color: #7b1fa2;
      }

      .ship-btn {
        background-color: #4caf50;
        color: white;
      }

      .ship-btn:hover {
        background-color: #388e3c;
      }

      .not-shipped-btn {
        background-color: #ff9800;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #f57c00;
      }

      .path-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: #7f8c8d;
        font-size: 12px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        color: white;
        background-color: #27ae60;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #27ae60;
      }

      .status-stopped {
        background-color: #e74c3c;
      }

      /* 配置区域样式 */
      .config-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .config-section:last-child {
        border-bottom: none;
      }

      .config-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      /* 模态框按钮区域 */
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* 配置按钮样式 */
      .config-button {
        background-color: #9b59b6;
      }

      .config-button:hover {
        background-color: #8e44ad;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* 处理状态显示 */
      .processing-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        background-color: #f8f9fa;
        display: none;
      }

      /* 数据库状态显示 */
      .db-status {
        display: flex;
        align-items: center;
        margin-left: auto;
        font-weight: bold;
      }

      .db-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .db-status-connected {
        background-color: #27ae60;
      }

      .db-status-disconnected {
        background-color: #e74c3c;
      }

      /* 同步状态显示 */
      .sync-status {
        display: flex;
        align-items: center;
        margin-left: 10px;
        font-weight: bold;
      }

      .sync-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .sync-status-idle {
        background-color: #95a5a6;
      }

      .sync-status-syncing {
        background-color: #3498db;
      }

      .sync-status-success {
        background-color: #27ae60;
      }

      .sync-status-error {
        background-color: #e74c3c;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>客户数据打包管理系统</h1>
    </div>

    <div class="control-panel">
      <div class="button-group">
        <button id="syncDataBtn">同步数据源到数据库</button>
        <button id="refreshBtn">刷新数据</button>
        <button id="configBtn" class="config-button">打开路径配置</button>
        <div id="syncStatus" class="sync-status">
          <span class="sync-status-indicator sync-status-idle"></span>
          <span>同步: 空闲</span>
        </div>
        <div id="dbStatus" class="db-status">
          <span class="db-status-indicator db-status-disconnected"></span>
          <span>数据库: 未连接</span>
        </div>
      </div>

      <div id="processingStatus" class="processing-status"></div>
    </div>

    <div class="customers-table">
      <h2 style="padding: 20px 20px 0 20px; text-align: center">
        客户信息和打包状态
      </h2>
      <table id="customersTable">
        <thead>
          <tr>
            <th>客户名称</th>
            <th>客户状态</th>
            <th>打包进度</th>
            <th>包号</th>
            <th>操作</th>
            <th>最后更新时间</th>
          </tr>
        </thead>
        <tbody>
          <!-- 数据将通过JavaScript动态填充 -->
        </tbody>
      </table>
    </div>
    <!-- 配置弹出层 -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>路径配置</h2>
        <form id="configForm">
          <div class="config-section">
            <h3>基本路径配置</h3>
            <div class="path-row">
              <span class="path-label">源地址:</span>
              <input
                type="text"
                id="sourcePathModal"
                class="path-input"
                placeholder="请输入源地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">输出地址:</span>
              <input
                type="text"
                id="outputPathModal"
                class="path-input"
                placeholder="请输入输出地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">网络路径:</span>
              <input
                type="text"
                id="networkPathModal"
                class="path-input"
                placeholder="网络同步路径（可选）"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>打包数据路径</h3>
            <div class="path-row">
              <span class="path-label">客户已打包数据:</span>
              <input
                type="text"
                id="customerPackedPathModal"
                class="path-input"
                placeholder="客户已打包数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">工人打包数据:</span>
              <input
                type="text"
                id="workerPackagesPathModal"
                class="path-input"
                placeholder="工人打包数据路径"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>自动保存路径</h3>
            <div class="path-row">
              <span class="path-label">自动保存客户数据:</span>
              <input
                type="text"
                id="autoSaveCustomerPathModal"
                class="path-input"
                placeholder="自动保存客户数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">自动保存工人数据:</span>
              <input
                type="text"
                id="autoSaveWorkerPathModal"
                class="path-input"
                placeholder="自动保存工人数据路径"
              />
            </div>
          </div>
          <div class="modal-buttons">
            <button type="submit" id="saveModalConfigBtn">保存配置</button>
            <button type="button" id="cancelModalBtn">取消</button>
          </div>
        </form>
      </div>
    </div>
    <div class="notification" id="notification"></div>

    <div class="footer">
      <p>客户数据打包管理系统 v1.0</p>
    </div>

    <script>
      // 检查是否在 Electron 环境中运行
      const isElectron = !!window.electronAPI;

      // 全局变量
      let isRunning = false;
      let config = {};

      // 显示通知
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor =
          type === 'success' ? '#27ae60' : '#e74c3c';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // 显示处理状态
      function showProcessingStatus(message, type = 'info') {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = message;
        statusElement.style.display = 'block';

        // 根据类型设置背景色
        if (type === 'error') {
          statusElement.style.backgroundColor = '#f8d7da';
          statusElement.style.color = '#721c24';
          statusElement.style.borderColor = '#f5c6cb';
        } else if (type === 'info') {
          statusElement.style.backgroundColor = '#d1ecf1';
          statusElement.style.color = '#0c5460';
          statusElement.style.borderColor = '#bee5eb';
        } else {
          statusElement.style.backgroundColor = '#d4edda';
          statusElement.style.color = '#155724';
          statusElement.style.borderColor = '#c3e6cb';
        }
      }

      // 隐藏处理状态
      function hideProcessingStatus() {
        const statusElement = document.getElementById('processingStatus');
        statusElement.style.display = 'none';
      }

      // 更新数据库连接状态显示
      function updateDBStatus(isConnected) {
        const dbStatusElement = document.getElementById('dbStatus');
        const indicator = dbStatusElement.querySelector('.db-status-indicator');
        const text = dbStatusElement.querySelector('span:last-child');

        if (isConnected) {
          indicator.className = 'db-status-indicator db-status-connected';
          text.textContent = '数据库: 已连接';
        } else {
          indicator.className = 'db-status-indicator db-status-disconnected';
          text.textContent = '数据库: 未连接';
        }
      }

      // 更新同步状态显示
      function updateSyncStatus(status, message = '') {
        const syncStatusElement = document.getElementById('syncStatus');
        const indicator = syncStatusElement.querySelector(
          '.sync-status-indicator'
        );
        const text = syncStatusElement.querySelector('span:last-child');

        switch (status) {
          case 'idle':
            indicator.className = 'sync-status-indicator sync-status-idle';
            text.textContent = message || '同步: 空闲';
            break;
          case 'syncing':
            indicator.className = 'sync-status-indicator sync-status-syncing';
            text.textContent = message || '同步: 同步中...';
            break;
          case 'success':
            indicator.className = 'sync-status-indicator sync-status-success';
            text.textContent = message || '同步: 成功';
            break;
          case 'error':
            indicator.className = 'sync-status-indicator sync-status-error';
            text.textContent = message || '同步: 错误';
            break;
        }
      }

      // 检查数据库连接状态
      async function checkDatabaseConnection() {
        try {
          if (isElectron && window.electronAPI) {
            const isConnected =
              await window.electronAPI.checkDatabaseConnection();
            updateDBStatus(isConnected);
            return isConnected;
          } else {
            // 在非Electron环境中，默认为连接状态
            updateDBStatus(true);
            return true;
          }
        } catch (error) {
          console.error('检查数据库连接状态时出错:', error);
          updateDBStatus(false);
          return false;
        }
      }

      // 同步数据源到数据库
      async function syncDataSourceToDatabase() {
        try {
          updateSyncStatus('syncing', '同步: 正在同步...');

          if (isElectron && window.electronAPI) {
            // 调用主进程的同步功能
            await window.electronAPI.syncDataSource();
            updateSyncStatus('success', '同步: 成功');
            showNotification('数据同步成功');

            // 刷新客户数据
            await loadCustomers();
          }
        } catch (error) {
          console.error('同步数据时出错:', error);
          updateSyncStatus('error', '同步: 错误');
          showNotification('数据同步失败: ' + error.message, 'error');
        }

        // 3秒后恢复空闲状态
        setTimeout(() => {
          updateSyncStatus('idle');
        }, 3000);
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', async () => {
        // 检查数据库连接状态
        await checkDatabaseConnection();

        // 获取配置
        try {
          if (isElectron && window.electronAPI) {
            config = await window.electronAPI.getConfig();
          }
        } catch (error) {
          console.error('获取配置时出错:', error);
          showNotification('获取配置失败: ' + error.message, 'error');
        }

        // 绑定事件监听器
        document
          .getElementById('syncDataBtn')
          .addEventListener('click', syncDataSourceToDatabase);
        document
          .getElementById('refreshBtn')
          .addEventListener('click', refreshData);
        document
          .getElementById('configBtn')
          .addEventListener('click', openConfigModal);

        // 绑定模态框事件
        document
          .querySelector('#configModal .close')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('cancelModalBtn')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('configForm')
          .addEventListener('submit', saveConfig);

        // 点击模态框外部关闭模态框
        window.addEventListener('click', event => {
          const modal = document.getElementById('configModal');
          if (event.target === modal) {
            closeConfigModal();
          }
        });

        // 初始加载客户数据
        loadCustomers();
      });

      // 刷新数据
      async function refreshData() {
        showProcessingStatus('正在刷新数据...');
        try {
          await loadCustomers();
          showNotification('数据刷新成功');
        } catch (error) {
          console.error('刷新数据时出错:', error);
          showNotification('数据刷新失败: ' + error.message, 'error');
        } finally {
          hideProcessingStatus();
        }
      }

      // 加载客户数据
      async function loadCustomers() {
        try {
          let customers = [];
          if (isElectron && window.electronAPI) {
            customers = await window.electronAPI.getCustomers();
          }

          const tableBody = document.querySelector('#customersTable tbody');
          tableBody.innerHTML = '';

          customers.forEach(customer => {
            const row = document.createElement('tr');

            // 确定状态类名
            let statusClass = 'status-not-packed';
            switch (customer.status) {
              case '未打包':
                statusClass = 'status-not-packed';
                break;
              case '打包中':
                statusClass = 'status-in-progress';
                break;
              case '已打包':
                statusClass = 'status-packed';
                break;
              case '已归档':
                statusClass = 'status-archived';
                break;
              case '已发货':
                statusClass = 'status-shipped';
                break;
              case '未发货':
                statusClass = 'status-not-shipped';
                break;
            }

            // 格式化最后更新时间
            const lastUpdate = customer.lastUpdate
              ? new Date(customer.lastUpdate).toLocaleString()
              : '无';

            row.innerHTML = `
              <td>${customer.name}</td>
              <td class="${statusClass}">${customer.status}</td>
              <td>
                <div class="progress-container">
                  <div class="progress-bar" style="width: ${
                    customer.packProgress || 0
                  }%; background-color: #3498db;"></div>
                  <div class="progress-text">${
                    customer.packProgress || 0
                  }%</div>
                </div>
              </td>
              <td>${customer.packSeqs ? customer.packSeqs.join(', ') : ''}</td>
              <td class="action-cell">
                <button class="action-btn archive-btn" onclick="updateCustomerStatus('${
                  customer.name
                }', '已归档')">归档</button>
                <button class="action-btn ship-btn" onclick="updateCustomerStatus('${
                  customer.name
                }', '已发货')">发货</button>
                <button class="action-btn not-shipped-btn" onclick="updateCustomerStatus('${
                  customer.name
                }', '未发货')">未发货</button>
              </td>
              <td>${lastUpdate}</td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error('加载客户数据时出错:', error);
          showNotification('加载客户数据失败: ' + error.message, 'error');
        }
      }

      // 更新客户状态
      async function updateCustomerStatus(customerName, status) {
        try {
          if (isElectron && window.electronAPI) {
            await window.electronAPI.updateCustomerStatus(customerName, status);
            showNotification(`客户 ${customerName} 状态已更新为 ${status}`);
            await loadCustomers(); // 重新加载数据以显示更新
          }
        } catch (error) {
          console.error('更新客户状态时出错:', error);
          showNotification('状态更新失败: ' + error.message, 'error');
        }
      }

      // 打开配置模态框
      async function openConfigModal() {
        try {
          if (isElectron && window.electronAPI) {
            const currentConfig = await window.electronAPI.getConfig();
            document.getElementById('sourcePathModal').value =
              currentConfig.sourcePath || '';
            document.getElementById('outputPathModal').value =
              currentConfig.localPath || '';
            document.getElementById('networkPathModal').value =
              currentConfig.networkPath || '';
            document.getElementById('customerPackedPathModal').value =
              currentConfig.customerPackedPath || '';
            document.getElementById('workerPackagesPathModal').value =
              currentConfig.workerPackagesPath || '';
            document.getElementById('autoSaveCustomerPathModal').value =
              currentConfig.autoSaveCustomerPath || '';
            document.getElementById('autoSaveWorkerPathModal').value =
              currentConfig.autoSaveWorkerPath || '';
          }
          document.getElementById('configModal').style.display = 'block';
        } catch (error) {
          console.error('打开配置模态框时出错:', error);
          showNotification('打开配置失败: ' + error.message, 'error');
        }
      }

      // 关闭配置模态框
      function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
      }

      // 保存配置
      async function saveConfig(event) {
        event.preventDefault();
        try {
          const newConfig = {
            sourcePath: document.getElementById('sourcePathModal').value,
            localPath: document.getElementById('outputPathModal').value,
            networkPath: document.getElementById('networkPathModal').value,
            customerPackedPath: document.getElementById(
              'customerPackedPathModal'
            ).value,
            workerPackagesPath: document.getElementById(
              'workerPackagesPathModal'
            ).value,
            autoSaveCustomerPath: document.getElementById(
              'autoSaveCustomerPathModal'
            ).value,
            autoSaveWorkerPath: document.getElementById(
              'autoSaveWorkerPathModal'
            ).value,
          };

          if (isElectron && window.electronAPI) {
            await window.electronAPI.saveConfig(newConfig);
            config = newConfig;
            showNotification('配置保存成功');
            closeConfigModal();
          }
        } catch (error) {
          console.error('保存配置时出错:', error);
          showNotification('配置保存失败: ' + error.message, 'error');
        }
      }
    </script>
  </body>
</html>
