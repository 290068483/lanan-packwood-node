<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>å®¢æˆ·æ•°æ®æ‰“åŒ…ç®¡ç†ç³»ç»Ÿ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #3498db;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }

      .control-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        margin-bottom: 15px;
        align-items: center;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .run-button {
        background-color: #27ae60;
      }

      .run-button:hover {
        background-color: #229954;
      }

      .stop-button {
        background-color: #e74c3c;
      }

      .stop-button:hover {
        background-color: #c0392b;
      }

      .path-config {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 3px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .path-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .path-label {
        width: 120px;
        font-weight: bold;
      }

      .path-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      /* å®¢æˆ·çŠ¶æ€æ ·å¼ */
      .status-not-packed {
        color: #95a5a6; /* ç°è‰² */
      }

      .status-in-progress {
        color: #3498db; /* è“è‰² */
      }

      .status-packed {
        color: #f1c40f; /* é»„è‰² */
      }

      .status-archived {
        color: #9b59b6; /* ç´«è‰² */
      }

      .status-shipped {
        color: #2ecc71; /* ç»¿è‰² */
      }

      .status-partial-shipped {
        color: #ff9800; /* æ©™è‰² */
      }

      .status-not-shipped {
        color: #e67e22; /* æ©™è‰² */
      }

      /* åŒçŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
      .dual-status-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .core-status {
        font-weight: bold;
        min-width: 60px;
      }

      .status-icons {
        display: flex;
        gap: 4px;
      }

      .status-icon {
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .status-icon:hover {
        transform: scale(1.2);
      }

      /* æ“ä½œæŒ‰é’®æ ·å¼ */
      .action-btn {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .archive-btn {
        background-color: #9b59b6;
        color: white;
      }

      .archive-btn:hover {
        background-color: #8e44ad;
      }

      .ship-btn {
        background-color: #2ecc71;
        color: white;
      }

      .ship-btn:hover {
        background-color: #27ae60;
      }

      .not-shipped-btn {
        background-color: #e67e22;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #d35400;
      }

      .customers-table {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status-processing {
        color: #f39c12;
        font-weight: bold;
      }

      .status-completed {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .status-not-packed {
        color: #888888;
        font-weight: bold;
      }

      .status-in-progress {
        color: #2196f3;
        font-weight: bold;
      }

      .status-packed {
        color: #ffc107;
        font-weight: bold;
      }

      .status-archived {
        color: #9c27b0;
        font-weight: bold;
      }

      .status-shipped {
        color: #4caf50;
        font-weight: bold;
      }

      .status-not-shipped {
        color: #ff9800;
        font-weight: bold;
      }

      /* è¿›åº¦æ¡æ ·å¼ */
      .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #333;
      }

      /* æ“ä½œæŒ‰é’®æ ·å¼ */
      .action-cell {
        white-space: nowrap;
      }

      .action-btn {
        margin: 0 3px;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .archive-btn {
        background-color: #9c27b0;
        color: white;
      }

      .archive-btn:hover {
        background-color: #7b1fa2;
      }

      .ship-btn {
        background-color: #4caf50;
        color: white;
      }

      .ship-btn:hover {
        background-color: #388e3c;
      }

      .not-shipped-btn {
        background-color: #ff9800;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #f57c00;
      }

      .path-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: #7f8c8d;
        font-size: 12px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        color: white;
        background-color: #27ae60;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #27ae60;
      }

      .status-stopped {
        background-color: #e74c3c;
      }

      /* é…ç½®åŒºåŸŸæ ·å¼ */
      .config-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .config-section:last-child {
        border-bottom: none;
      }

      .config-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      /* æ¨¡æ€æ¡†æŒ‰é’®åŒºåŸŸ */
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* é…ç½®æŒ‰é’®æ ·å¼ */
      .config-button {
        background-color: #9b59b6;
      }

      .config-button:hover {
        background-color: #8e44ad;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
      }

      /* æ•°æ®åº“åˆ‡æ¢å¼€å…³æ ·å¼ */
      .database-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
        margin-right: 20px;
      }

      .database-switch label {
        font-weight: bold;
        color: #34495e;
      }

      .database-switch select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 3px;
        background-color: white;
        font-size: 14px;
        cursor: pointer;
        min-width: 120px;
      }

      .database-switch select:hover {
        border-color: #3498db;
      }

      .database-switch select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        height: 18px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* å¤„ç†çŠ¶æ€æ˜¾ç¤º */
      .processing-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        background-color: #f8f9fa;
        display: none;
      }

      /* æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º */
      .db-status {
        display: flex;
        align-items: center;
        margin-left: auto;
        font-weight: bold;
      }

      .db-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .db-status-connected {
        background-color: #27ae60;
      }

      .db-status-disconnected {
        background-color: #e74c3c;
      }

      /* åŒæ­¥çŠ¶æ€æ˜¾ç¤º */
      .sync-status {
        display: flex;
        align-items: center;
        margin-left: 10px;
        font-weight: bold;
      }

      .sync-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .sync-status-idle {
        background-color: #95a5a6;
      }

      .sync-status-syncing {
        background-color: #3498db;
      }

      .sync-status-success {
        background-color: #27ae60;
      }

      .sync-status-error {
        background-color: #e74c3c;
      }

      /* å†å²è®°å½•è¡¨æ ¼æ ·å¼ */
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .history-table th,
      .history-table td {
        padding: 8px 12px;
        border: 1px solid #ddd;
        text-align: left;
        color: black;
      }

      .history-table th {
        background-color: #f2f2f2;
        font-weight: bold;
      }

      .history-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      .history-table tr:hover {
        background-color: #f1f1f1;
      }

      /* å½’æ¡£è¯¦æƒ…æ ·å¼ */
      .archive-detail {
        padding: 15px;
      }

      .info-section {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .info-section:last-child {
        border-bottom: none;
      }

      .info-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-item label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }

      .info-item.full-width {
        grid-column: 1 / -1;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 10px;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }

      .no-data {
        text-align: center;
        padding: 20px;
        color: #777;
        font-style: italic;
      }

      /* é‡æ–°å¯åŠ¨æŒ‰é’®æ ·å¼ */
      .restart-button {
        background-color: #e67e22;
      }

      .restart-button:hover {
        background-color: #d35400;
      }

      /* å½’æ¡£å†å²æŒ‰é’®æ ·å¼ */
      .archive-button {
        background-color: #9b59b6;
      }

      .archive-button:hover {
        background-color: #8e44ad;
      }

      /* å‡ºè´§é€‰æ‹©å¯¹è¯æ¡†æ ·å¼ */
      .ship-options {
        display: flex;
        gap: 20px;
        margin: 20px 0;
      }

      .ship-option {
        flex: 1;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        transition: border-color 0.3s;
      }

      .ship-option:hover {
        border-color: #3498db;
      }

      .ship-option h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
      }

      .ship-option p {
        margin: 0 0 15px 0;
        color: #7f8c8d;
        font-size: 14px;
      }

      .ship-option-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .ship-option-btn:hover {
        background-color: #2980b9;
      }

      .ship-option-btn[data-ship-type='full'] {
        background-color: #27ae60;
      }

      .ship-option-btn[data-ship-type='full']:hover {
        background-color: #219a52;
      }

      .ship-option-btn[data-ship-type='partial'] {
        background-color: #f39c12;
      }

      .ship-option-btn[data-ship-type='partial']:hover {
        background-color: #e67e22;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>å®¢æˆ·æ•°æ®æ‰“åŒ…ç®¡ç†ç³»ç»Ÿ</h1>
    </div>

    <div class="control-panel">
      <div class="button-group">
        <button id="syncDataBtn">åŒæ­¥æ•°æ®æºåˆ°æ•°æ®åº“</button>
        <button id="refreshBtn">åˆ·æ–°æ•°æ®</button>
        <button id="archiveHistoryBtn" class="archive-button">å½’æ¡£å†å²</button>
        <button id="restartBtn" class="restart-button">é‡æ–°å¯åŠ¨</button>
        <button id="configBtn" class="config-button">æ‰“å¼€è·¯å¾„é…ç½®</button>
        <div class="database-switch">
          <label for="dbSwitch">æ•°æ®åº“:</label>
          <select id="dbSwitch">
            <option value="production">ç”Ÿäº§æ•°æ®åº“</option>
            <option value="test">æµ‹è¯•æ•°æ®åº“</option>
          </select>
        </div>
        <div id="syncStatus" class="sync-status">
          <span class="sync-status-indicator sync-status-idle"></span>
          <span>åŒæ­¥: ç©ºé—²</span>
        </div>
        <div id="dbStatus" class="db-status">
          <span class="db-status-indicator db-status-disconnected"></span>
          <span>æ•°æ®åº“: æœªè¿æ¥</span>
        </div>
      </div>

      <div id="processingStatus" class="processing-status"></div>
    </div>

    <div class="customers-table">
      <h2 style="padding: 20px 20px 0 20px; text-align: center">
        å®¢æˆ·ä¿¡æ¯å’Œæ‰“åŒ…çŠ¶æ€
      </h2>
      <table id="customersTable">
        <thead>
          <tr>
            <th>å®¢æˆ·åç§°</th>
            <th>å®¢æˆ·çŠ¶æ€</th>
            <th id="progressHeader" style="display: none;">æ‰“åŒ…è¿›åº¦</th>
            <th>åŒ…å·</th>
            <th>æ“ä½œ</th>
            <th>æœ€åæ›´æ–°æ—¶é—´</th>
          </tr>
        </thead>
        <tbody>
          <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
        </tbody>
</div>
        </div>
      </div>

    <!-- å‡ºè´§é€‰æ‹©å¯¹è¯æ¡† -->
    <div id="shipModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>é€‰æ‹©å‡ºè´§ç±»å‹</h2>
        <div class="ship-options">
          <div class="ship-option">
            <h3>å…¨éƒ¨å‡ºè´§</h3>
            <p>å°†å®¢æˆ·çš„æ‰€æœ‰æ¿ä»¶æ ‡è®°ä¸ºå·²å‡ºè´§çŠ¶æ€</p>
            <button class="ship-option-btn" data-ship-type="full">å…¨éƒ¨å‡ºè´§</button>
          </div>
          <div class="ship-option">
            <h3>éƒ¨åˆ†å‡ºè´§</h3>
            <p>å°†å®¢æˆ·çš„éƒ¨åˆ†æ¿ä»¶æ ‡è®°ä¸ºå·²å‡ºè´§çŠ¶æ€</p>
            <button class="ship-option-btn" data-ship-type="partial">éƒ¨åˆ†å‡ºè´§</button>
          </div>
        </div>
        <div class="modal-buttons">
          <button type="button" id="cancelShipBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- é…ç½®å¼¹å‡ºå±‚ -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>è·¯å¾„é…ç½®</h2>
        <form id="configForm">
          <div class="config-section">
            <h3>åŸºæœ¬è·¯å¾„é…ç½®</h3>
            <div class="path-row">
              <span class="path-label">æºåœ°å€:</span>
              <input
                type="text"
                id="sourcePathModal"
                class="path-input"
                placeholder="è¯·è¾“å…¥æºåœ°å€"
              />
            </div>
            <div class="path-row">
              <span class="path-label">è¾“å‡ºåœ°å€:</span>
              <input
                type="text"
                id="outputPathModal"
                class="path-input"
                placeholder="è¯·è¾“å…¥è¾“å‡ºåœ°å€"
              />
            </div>
            <div class="path-row">
              <span class="path-label">ç½‘ç»œè·¯å¾„:</span>
              <input
                type="text"
                id="networkPathModal"
                class="path-input"
                placeholder="ç½‘ç»œåŒæ­¥è·¯å¾„ï¼ˆå¯é€‰ï¼‰"
              />
            </div>
          </div>
          <!-- <div class="config-section">
            <h3>æ‰“åŒ…æ•°æ®è·¯å¾„</h3>
            <div class="path-row">
              <span class="path-label">å®¢æˆ·å·²æ‰“åŒ…æ•°æ®:</span>
              <input
                type="text"
                id="customerPackedPathModal"
                class="path-input"
                placeholder="å®¢æˆ·å·²æ‰“åŒ…æ•°æ®è·¯å¾„"
              />
            </div>
            <div class="path-row">
              <span class="path-label">å·¥äººæ‰“åŒ…æ•°æ®:</span>
              <input
                type="text"
                id="workerPackagesPathModal"
                class="path-input"
                placeholder="å·¥äººæ‰“åŒ…æ•°æ®è·¯å¾„"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>è‡ªåŠ¨ä¿å­˜è·¯å¾„</h3>
            <div class="path-row">
              <span class="path-label">è‡ªåŠ¨ä¿å­˜å®¢æˆ·æ•°æ®:</span>
              <input
                type="text"
                id="autoSaveCustomerPathModal"
                class="path-input"
                placeholder="è‡ªåŠ¨ä¿å­˜å®¢æˆ·æ•°æ®è·¯å¾„"
              />
            </div>
            <div class="path-row">
              <span class="path-label">è‡ªåŠ¨ä¿å­˜å·¥äººæ•°æ®:</span>
              <input
                type="text"
                id="autoSaveWorkerPathModal"
                class="path-input"
                placeholder="è‡ªåŠ¨ä¿å­˜å·¥äººæ•°æ®è·¯å¾„"
              />
            </div>
          </div> -->
          <div class="modal-buttons">
            <button type="submit" id="saveModalConfigBtn">ä¿å­˜é…ç½®</button>
            <button type="button" id="cancelModalBtn">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- å‡ºè´§é€‰æ‹©å¼¹å‡ºå±‚ -->
    <div id="shipModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>é€‰æ‹©å‡ºè´§ç±»å‹</h2>
        <div class="ship-options">
          <div class="ship-option">
            <h3>å…¨éƒ¨å‡ºè´§</h3>
            <p>å°†å®¢æˆ·æ‰€æœ‰äº§å“å…¨éƒ¨å‡ºè´§ï¼ŒçŠ¶æ€æ›´æ–°ä¸º"å…¨éƒ¨å‡ºè´§"</p>
            <button class="ship-option-btn" data-ship-type="full">
              å…¨éƒ¨å‡ºè´§
            </button>
          </div>
          <div class="ship-option">
            <h3>éƒ¨åˆ†å‡ºè´§</h3>
            <p>å°†å®¢æˆ·éƒ¨åˆ†äº§å“å‡ºè´§ï¼ŒçŠ¶æ€æ›´æ–°ä¸º"éƒ¨åˆ†å‡ºè´§"</p>
            <button class="ship-option-btn" data-ship-type="partial">
              éƒ¨åˆ†å‡ºè´§
            </button>
          </div>
        </div>
        <div class="modal-buttons">
          <button type="button" id="cancelShipBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <div class="notification" id="notification"></div>

    <div class="footer">
      <p>å®¢æˆ·æ•°æ®æ‰“åŒ…ç®¡ç†ç³»ç»Ÿ v1.0</p>
    </div>

    <script>
      // æ£€æŸ¥æ˜¯å¦åœ¨ Electron ç¯å¢ƒä¸­è¿è¡Œ
      const isElectron = !!window.electronAPI;

      // å…¨å±€å˜é‡
      let isRunning = false;
      let config = {};

      // æ˜¾ç¤ºé€šçŸ¥
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor =
          type === 'success' ? '#27ae60' : '#e74c3c';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
      function showProcessingStatus(message, type = 'info') {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = message;
        statusElement.style.display = 'block';

        // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
        if (type === 'error') {
          statusElement.style.backgroundColor = '#f8d7da';
          statusElement.style.color = '#721c24';
          statusElement.style.borderColor = '#f5c6cb';
        } else if (type === 'info') {
          statusElement.style.backgroundColor = '#d1ecf1';
          statusElement.style.color = '#0c5460';
          statusElement.style.borderColor = '#bee5eb';
        } else {
          statusElement.style.backgroundColor = '#d4edda';
          statusElement.style.color = '#155724';
          statusElement.style.borderColor = '#c3e6cb';
        }
      }

      // éšè—å¤„ç†çŠ¶æ€
      function hideProcessingStatus() {
        const statusElement = document.getElementById('processingStatus');
        statusElement.style.display = 'none';
      }

      // æ›´æ–°æ•°æ®åº“è¿æ¥çŠ¶æ€æ˜¾ç¤º
      function updateDBStatus(isConnected) {
        const dbStatusElement = document.getElementById('dbStatus');
        const indicator = dbStatusElement.querySelector('.db-status-indicator');
        const text = dbStatusElement.querySelector('span:last-child');

        if (isConnected) {
          indicator.className = 'db-status-indicator db-status-connected';
          text.textContent = 'æ•°æ®åº“: å·²è¿æ¥';
        } else {
          indicator.className = 'db-status-indicator db-status-disconnected';
          text.textContent = 'æ•°æ®åº“: æœªè¿æ¥';
        }
      }

      // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
      function updateSyncStatus(status, message = '') {
        const syncStatusElement = document.getElementById('syncStatus');
        const indicator = syncStatusElement.querySelector(
          '.sync-status-indicator'
        );
        const text = syncStatusElement.querySelector('span:last-child');

        switch (status) {
          case 'idle':
            indicator.className = 'sync-status-indicator sync-status-idle';
            text.textContent = message || 'åŒæ­¥: ç©ºé—²';
            break;
          case 'syncing':
            indicator.className = 'sync-status-indicator sync-status-syncing';
            text.textContent = message || 'åŒæ­¥: åŒæ­¥ä¸­...';
            break;
          case 'success':
            indicator.className = 'sync-status-indicator sync-status-success';
            text.textContent = message || 'åŒæ­¥: æˆåŠŸ';
            break;
          case 'error':
            indicator.className = 'sync-status-indicator sync-status-error';
            text.textContent = message || 'åŒæ­¥: é”™è¯¯';
            break;
        }
      }

      // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
      async function checkDatabaseConnection() {
        try {
          if (isElectron && window.electronAPI) {
            const isConnected =
              await window.electronAPI.checkDatabaseConnection();
            updateDBStatus(isConnected);
            return isConnected;
          } else {
            // åœ¨éElectronç¯å¢ƒä¸­ï¼Œé»˜è®¤ä¸ºè¿æ¥çŠ¶æ€
            updateDBStatus(true);
            return true;
          }
        } catch (error) {
          console.error('æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€æ—¶å‡ºé”™:', error);
          updateDBStatus(false);
          return false;
        }
      }

      // åŒæ­¥æ•°æ®æºåˆ°æ•°æ®åº“
      async function syncDataSourceToDatabase() {
        try {
          updateSyncStatus('syncing', 'åŒæ­¥: æ­£åœ¨åŒæ­¥...');

          if (isElectron && window.electronAPI) {
            // è°ƒç”¨ä¸»è¿›ç¨‹çš„åŒæ­¥åŠŸèƒ½
            await window.electronAPI.syncDataSource();
            updateSyncStatus('success', 'åŒæ­¥: æˆåŠŸ');
            showNotification('æ•°æ®åŒæ­¥æˆåŠŸ');

            // åˆ·æ–°å®¢æˆ·æ•°æ®
            await loadCustomers();
          }
        } catch (error) {
          console.error('åŒæ­¥æ•°æ®æ—¶å‡ºé”™:', error);
          updateSyncStatus('error', 'åŒæ­¥: é”™è¯¯');
          showNotification('æ•°æ®åŒæ­¥å¤±è´¥: ' + error.message, 'error');
        }

        // 3ç§’åæ¢å¤ç©ºé—²çŠ¶æ€
        setTimeout(() => {
          updateSyncStatus('idle');
        }, 3000);
      }

      // åˆå§‹åŒ–æ•°æ®åº“ç±»å‹é€‰æ‹©å™¨
      async function initDatabaseSwitch() {
        try {
          let currentDbType = 'production'; // é»˜è®¤ç”Ÿäº§æ•°æ®åº“
          
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­è·å–å½“å‰æ•°æ®åº“ç±»å‹
            const result = await window.electronAPI.getCurrentDbType();
            if (result.success) {
              currentDbType = result.currentDbType;
            }
          } else {
            // Webç¯å¢ƒä¸­è°ƒç”¨API
            const response = await fetch('/api/database/current');
            const result = await response.json();
            if (result.success) {
              currentDbType = result.currentDbType;
            }
          }
          
          const dbSwitch = document.getElementById('dbSwitch');
          if (dbSwitch) {
            dbSwitch.value = currentDbType;
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–æ•°æ®åº“åˆ‡æ¢å™¨æ—¶å‡ºé”™:', error);
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async () => {
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
        await checkDatabaseConnection();

        // è·å–é…ç½®
        try {
          if (isElectron && window.electronAPI) {
            config = await window.electronAPI.getConfig();
          }
        } catch (error) {
          console.error('è·å–é…ç½®æ—¶å‡ºé”™:', error);
          showNotification('è·å–é…ç½®å¤±è´¥: ' + error.message, 'error');
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        document
          .getElementById('syncDataBtn')
          .addEventListener('click', syncDataSourceToDatabase);
        document
          .getElementById('refreshBtn')
          .addEventListener('click', refreshData);
        document
          .getElementById('archiveHistoryBtn')
          .addEventListener('click', showArchiveHistory);
        document
          .getElementById('restartBtn')
          .addEventListener('click', restartApplication);
        document
          .getElementById('configBtn')
          .addEventListener('click', openConfigModal);
        
        // ç»‘å®šæ•°æ®åº“åˆ‡æ¢äº‹ä»¶
        document
          .getElementById('dbSwitch')
          .addEventListener('change', async (event) => {
            const dbType = event.target.value;
            const originalValue = event.target.value === 'production' ? 'test' : 'production';
            try {
              showProcessingStatus('æ­£åœ¨åˆ‡æ¢æ•°æ®åº“...');
              
              if (isElectron && window.electronAPI) {
                // Electronç¯å¢ƒä¸­è°ƒç”¨ä¸»è¿›ç¨‹çš„æ•°æ®åº“åˆ‡æ¢åŠŸèƒ½
                const result = await window.electronAPI.switchDatabase(dbType);
                if (result.success) {
                  showNotification(`å·²åˆ‡æ¢åˆ°${dbType === 'production' ? 'ç”Ÿäº§' : 'æµ‹è¯•'}æ•°æ®åº“`);
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(`åˆ‡æ¢æ•°æ®åº“å¤±è´¥: ${result.message}`, 'error');
                  // æ¢å¤åŸå§‹é€‰æ‹©
                  event.target.value = originalValue;
                }
              } else {
                // Webç¯å¢ƒä¸­è°ƒç”¨API
                const response = await fetch('/api/database/switch', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ dbType }),
                });
                const result = await response.json();
                
                if (result.success) {
                  showNotification(`å·²åˆ‡æ¢åˆ°${dbType === 'production' ? 'ç”Ÿäº§' : 'æµ‹è¯•'}æ•°æ®åº“`);
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(`åˆ‡æ¢æ•°æ®åº“å¤±è´¥: ${result.message}`, 'error');
                  // æ¢å¤åŸå§‹é€‰æ‹©
                  event.target.value = originalValue;
                }
              }
              
              showProcessingStatus('');
            } catch (error) {
              console.error('åˆ‡æ¢æ•°æ®åº“æ—¶å‡ºé”™:', error);
              showNotification('åˆ‡æ¢æ•°æ®åº“å¤±è´¥: ' + error.message, 'error');
              // æ¢å¤åŸå§‹é€‰æ‹©
              event.target.value = originalValue;
              showProcessingStatus('');
            }
          });
          
        // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
        await initDatabaseSwitch();

        // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
        document
          .querySelector('#configModal .close')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('cancelModalBtn')
          .addEventListener('click', closeConfigModal);
        document
          .getElementById('configForm')
          .addEventListener('submit', saveConfig);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        window.addEventListener('click', event => {
          const modal = document.getElementById('configModal');
          if (event.target === modal) {
            closeConfigModal();
          }
        });

        // åˆå§‹åŠ è½½å®¢æˆ·æ•°æ®
        loadCustomers();

        // æ£€æŸ¥çŠ¶æ€æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('check-status-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              let result;
              if (isElectron) {
                // Electronç¯å¢ƒä¸­è°ƒç”¨æ£€æŸ¥åŠŸèƒ½
                result = await window.electronAPI.checkCustomerStatus(
                  customerName
                );
              } else {
                // Webç¯å¢ƒä¸­è°ƒç”¨API
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(
                    customerName
                  )}/check-status`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                result = await response.json();
              }

              if (result.success) {
                showNotification(
                  `å®¢æˆ· ${customerName} çŠ¶æ€: ${result.status}, æ‰“åŒ…è¿›åº¦: ${result.packProgress}%`,
                  'info'
                );
                // åˆ·æ–°å®¢æˆ·æ•°æ®
                await loadCustomers();
              } else {
                showNotification(`æ£€æŸ¥çŠ¶æ€å¤±è´¥: ${result.message}`, 'error');
              }
            } catch (error) {
              console.error('æ£€æŸ¥å®¢æˆ·çŠ¶æ€å‡ºé”™:', error);
              showNotification(`æ£€æŸ¥å®¢æˆ·çŠ¶æ€å‡ºé”™: ${error.message}`, 'error');
            }
          }

          // å¤„ç†'å»å¤„ç†'æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          if (event.target.classList.contains('process-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              if (isElectron) {
                // Electronç¯å¢ƒä¸­è°ƒç”¨æ‰“å¼€Excelæ–‡ä»¶åŠŸèƒ½
                await window.electronAPI.openCustomerExcelFile(customerName);
              } else {
                // Webç¯å¢ƒä¸­è°ƒç”¨APIè·å–Excelæ–‡ä»¶è·¯å¾„
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(
                    customerName
                  )}/open-excel`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                const result = await response.json();

                if (result.success) {
                  // åœ¨Webæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æç¤ºç”¨æˆ·æ‰‹åŠ¨æ‰“å¼€æ–‡ä»¶
                  showNotification(
                    `è¯·æ‰‹åŠ¨æ‰“å¼€æ–‡ä»¶: ${result.filePath}`,
                    'info'
                  );
                } else {
                  showNotification(
                    `æŸ¥æ‰¾Excelæ–‡ä»¶å¤±è´¥: ${result.message}`,
                    'error'
                  );
                }
              }
            } catch (error) {
              console.error('æ‰“å¼€Excelæ–‡ä»¶å‡ºé”™:', error);
              showNotification(`æ‰“å¼€Excelæ–‡ä»¶å‡ºé”™: ${error.message}`, 'error');
            }
          }

          // å¤„ç†'å½’æ¡£'æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          if (event.target.classList.contains('archive-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              if (isElectron) {
                // Electronç¯å¢ƒä¸­è°ƒç”¨å½’æ¡£åŠŸèƒ½
                const result = await window.electronAPI.archiveCustomer(
                  customerName
                );

                if (result.success) {
                  showNotification(`å®¢æˆ· ${customerName} å½’æ¡£æˆåŠŸ`);
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(`å½’æ¡£å¤±è´¥: ${result.message}`, 'error');
                }
              } else {
                // Webç¯å¢ƒä¸­è°ƒç”¨API
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(customerName)}/archive`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                const result = await response.json();

                if (result.success) {
                  showNotification(`å®¢æˆ· ${customerName} å½’æ¡£æˆåŠŸ`);
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(`å½’æ¡£å¤±è´¥: ${result.message}`, 'error');
                }
              }
            } catch (error) {
              console.error('å½’æ¡£å®¢æˆ·å‡ºé”™:', error);
              showNotification(`å½’æ¡£å®¢æˆ·å‡ºé”™: ${error.message}`, 'error');
            }
          }
        });

        // æ˜¾ç¤ºå‡ºè´§é€‰æ‹©å¯¹è¯æ¡†
        function showShipModal(customerName) {
          const shipModal = document.getElementById('shipModal');
          shipModal.style.display = 'block';

          // å­˜å‚¨å½“å‰å®¢æˆ·åç§°ï¼Œä¾›åç»­ä½¿ç”¨
          shipModal.dataset.customerName = customerName;
        }

        // å‡ºè´§æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('ship-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            // æ˜¾ç¤ºå‡ºè´§é€‰æ‹©å¯¹è¯æ¡†
            showShipModal(customerName);
          }
        });

        // å‡ºè´§é€‰æ‹©æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('ship-option-btn')) {
            const shipType = event.target.dataset.shipType;
            const shipModal = document.getElementById('shipModal');
            const customerName = shipModal.dataset.customerName;

            // å…³é—­å¯¹è¯æ¡†
            shipModal.style.display = 'none';

            if (!customerName) {
              showNotification('å®¢æˆ·ä¿¡æ¯æ— æ•ˆ', 'error');
              return;
            }

            try {
              let result;
              if (isElectron) {
                // Electronç¯å¢ƒä¸­è°ƒç”¨å‡ºè´§åŠŸèƒ½
                if (shipType === 'full') {
                  result = await window.electronAPI.shipCustomer(customerName);
                } else if (shipType === 'partial') {
                  result = await window.electronAPI.partialShipCustomer(
                    customerName
                  );
                }
              } else {
                // Webç¯å¢ƒä¸­è°ƒç”¨API
                let apiUrl;
                if (shipType === 'full') {
                  apiUrl = `/api/customers/${encodeURIComponent(
                    customerName
                  )}/ship`;
                } else if (shipType === 'partial') {
                  apiUrl = `/api/customers/${encodeURIComponent(
                    customerName
                  )}/partial-ship`;
                }

                const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    remark:
                      shipType === 'full'
                        ? 'é€šè¿‡ç•Œé¢å…¨éƒ¨å‡ºè´§'
                        : 'é€šè¿‡ç•Œé¢éƒ¨åˆ†å‡ºè´§',
                  }),
                });
                result = await response.json();
              }

              if (result.success) {
                const shipTypeText =
                  shipType === 'full' ? 'å…¨éƒ¨å‡ºè´§' : 'éƒ¨åˆ†å‡ºè´§';
                showNotification(
                  `å®¢æˆ· ${customerName} ${shipTypeText}æˆåŠŸ`,
                  'success'
                );
                // åˆ·æ–°å®¢æˆ·æ•°æ®
                await loadCustomers();
              } else {
                showNotification(`å‡ºè´§å¤±è´¥: ${result.message}`, 'error');
              }
            } catch (error) {
              console.error('å‡ºè´§å®¢æˆ·å‡ºé”™:', error);
              showNotification(`å‡ºè´§å®¢æˆ·å‡ºé”™: ${error.message}`, 'error');
            }
          }
        });

        // å‡ºè´§å¯¹è¯æ¡†å–æ¶ˆæŒ‰é’®äº‹ä»¶
        document.addEventListener('click', event => {
          if (event.target.id === 'cancelShipBtn') {
            const shipModal = document.getElementById('shipModal');
            shipModal.style.display = 'none';
          }
        });

        // å‡ºè´§å¯¹è¯æ¡†å…³é—­æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', event => {
          if (
            event.target.classList.contains('close') &&
            event.target.closest('#shipModal')
          ) {
            const shipModal = document.getElementById('shipModal');
            shipModal.style.display = 'none';
          }
        });

        // æ ‡è®°ä¸ºæœªå‡ºè´§æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('not-shipped-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            if (confirm(`ç¡®å®šè¦å°†å®¢æˆ· ${customerName} æ ‡è®°ä¸ºæœªå‡ºè´§å—ï¼Ÿ`)) {
              try {
                let result;
                if (isElectron) {
                  // Electronç¯å¢ƒä¸­è°ƒç”¨æ ‡è®°åŠŸèƒ½
                  result = await window.electronAPI.markCustomerNotShipped(
                    customerName
                  );
                } else {
                  // Webç¯å¢ƒä¸­è°ƒç”¨API
                  const response = await fetch(
                    `/api/customers/${encodeURIComponent(
                      customerName
                    )}/mark-not-shipped`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        remark: 'é€šè¿‡ç•Œé¢æ ‡è®°ä¸ºæœªå‡ºè´§',
                      }),
                    }
                  );
                  result = await response.json();
                }

                if (result.success) {
                  showNotification(
                    `å®¢æˆ· ${customerName} å·²æ ‡è®°ä¸ºæœªå‡ºè´§`,
                    'success'
                  );
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(`æ ‡è®°å¤±è´¥: ${result.message}`, 'error');
                }
              } catch (error) {
                console.error('æ ‡è®°å®¢æˆ·ä¸ºæœªå‡ºè´§å‡ºé”™:', error);
                showNotification(
                  `æ ‡è®°å®¢æˆ·ä¸ºæœªå‡ºè´§å‡ºé”™: ${error.message}`,
                  'error'
                );
              }
            }
          }
        });
      });

      // åˆ·æ–°æ•°æ®
      async function refreshData() {
        showProcessingStatus('æ­£åœ¨åˆ·æ–°æ•°æ®...');
        try {
          await loadCustomers();
          showNotification('æ•°æ®åˆ·æ–°æˆåŠŸ');
        } catch (error) {
          console.error('åˆ·æ–°æ•°æ®æ—¶å‡ºé”™:', error);
          showNotification('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
        } finally {
          hideProcessingStatus();
        }
      }

      // åŠ è½½å®¢æˆ·æ•°æ®
      async function loadCustomers() {
        try {
          let customers = [];
          if (isElectron && window.electronAPI) {
            customers = await window.electronAPI.getCustomers();
          }

          const tableBody = document.querySelector('#customersTable tbody');
          tableBody.innerHTML = '';

          // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨å¤„ç†çŠ¶æ€çš„å®¢æˆ·ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºæ‰“åŒ…è¿›åº¦åˆ—
          const hasProcessingCustomers = customers.some(customer => customer.status === 'æ­£åœ¨å¤„ç†');
          const progressHeader = document.getElementById('progressHeader');
          if (progressHeader) {
            progressHeader.style.display = hasProcessingCustomers ? '' : 'none';
          }

          customers.forEach(customer => {
            const row = document.createElement('tr');

            // åŒçŠ¶æ€æ˜¾ç¤ºï¼šæ ¸å¿ƒé—®é¢˜çŠ¶æ€ + æµç¨‹çŠ¶æ€å›¾æ ‡åºåˆ—
            let statusClass = 'status-not-packed';
            let coreStatus = customer.status; // æ ¸å¿ƒé—®é¢˜çŠ¶æ€
            let shipmentStatus = customer.shipmentStatus || 'æœªå‡ºè´§'; // å‡ºè´§çŠ¶æ€
            
            // ç¡®å®šæ ¸å¿ƒé—®é¢˜çŠ¶æ€ï¼ˆä¼˜å…ˆæ˜¾ç¤ºéœ€è¦å…³æ³¨çš„çŠ¶æ€ï¼‰
            if (customer.status === 'æœªæ‰“åŒ…') {
              coreStatus = 'æœªæ‰“åŒ…';
              statusClass = 'status-not-packed';
            } else if (customer.status === 'æ­£åœ¨å¤„ç†') {
              coreStatus = 'æ­£åœ¨å¤„ç†';
              statusClass = 'status-in-progress';
            } else if (customer.status === 'å·²æ‰“åŒ…') {
              // å·²æ‰“åŒ…çŠ¶æ€ä¸‹ï¼Œæ£€æŸ¥å‡ºè´§çŠ¶æ€
              if (customer.shipmentStatus === 'éƒ¨åˆ†å‡ºè´§') {
                coreStatus = 'éƒ¨åˆ†å‡ºè´§';
                statusClass = 'status-partial-shipped';
              } else if (customer.shipmentStatus === 'æœªå‡ºè´§') {
                coreStatus = 'å·²æ‰“åŒ…';
                statusClass = 'status-packed';
              } else if (customer.shipmentStatus === 'å…¨éƒ¨å‡ºè´§') {
                coreStatus = 'å…¨éƒ¨å‡ºè´§';
                statusClass = 'status-shipped';
              }
            } else if (customer.status === 'å·²å½’æ¡£') {
              // å·²å½’æ¡£çŠ¶æ€ä¸‹ï¼Œæ£€æŸ¥å‡ºè´§çŠ¶æ€
              if (customer.shipmentStatus === 'éƒ¨åˆ†å‡ºè´§') {
                coreStatus = 'éƒ¨åˆ†å‡ºè´§';
                statusClass = 'status-partial-shipped';
              } else if (customer.shipmentStatus === 'æœªå‡ºè´§') {
                coreStatus = 'å·²å½’æ¡£';
                statusClass = 'status-archived';
              } else if (customer.shipmentStatus === 'å…¨éƒ¨å‡ºè´§') {
                coreStatus = 'å…¨éƒ¨å‡ºè´§';
                statusClass = 'status-shipped';
              }
            }

            // è·å–çŠ¶æ€å›¾æ ‡
            function getStatusIcon(status) {
              switch (status) {
                case 'æœªæ‰“åŒ…':
                  return 'ğŸ“¦';
                case 'æ­£åœ¨å¤„ç†':
                  return 'ğŸ“¦';
                case 'å·²æ‰“åŒ…':
                  return 'ğŸ“¦';
                case 'å·²å½’æ¡£':
                  return 'ğŸ“¦';
                case 'å…¨éƒ¨å‡ºè´§':
                  return 'ğŸšš';
                case 'éƒ¨åˆ†å‡ºè´§':
                  return 'ğŸšš';
                case 'æœªå‡ºè´§':
                  return 'ğŸšš';
                default:
                  return 'ğŸ“¦';
              }
            }

            // è·å–çŠ¶æ€é¢œè‰²
            function getStatusColor(status) {
              switch (status) {
                case 'æœªæ‰“åŒ…':
                  return '#888888';
                case 'æ­£åœ¨å¤„ç†':
                  return '#2196F3';
                case 'å·²æ‰“åŒ…':
                  return '#FFC107';
                case 'å·²å½’æ¡£':
                  return '#9C27B0';
                case 'å…¨éƒ¨å‡ºè´§':
                  return '#4CAF50';
                case 'éƒ¨åˆ†å‡ºè´§':
                  return '#FFCA28';
                case 'æœªå‡ºè´§':
                  return '#888888';
                default:
                  return '#888888';
              }
            }

            // æ„å»ºåŒçŠ¶æ€æ˜¾ç¤ºHTML
            const statusIcon = getStatusIcon(customer.status);
            const shipmentIcon = getStatusIcon(shipmentStatus);
            const statusColor = getStatusColor(customer.status);
            const shipmentColor = getStatusColor(shipmentStatus);

            const statusDisplay = `
              <div class="dual-status-container">
                <div class="core-status ${statusClass}">${coreStatus}</div>
                <div class="status-icons">
                  <span class="status-icon" style="color: ${statusColor}" title="æ‰“åŒ…çŠ¶æ€: ${customer.status}">${statusIcon}</span>
                  <span class="status-icon" style="color: ${shipmentColor}" title="å‡ºè´§çŠ¶æ€: ${shipmentStatus}">${shipmentIcon}</span>
                </div>
              </div>
            `;

            // æ ¼å¼åŒ–æœ€åæ›´æ–°æ—¶é—´
            const lastUpdate = customer.lastUpdate
              ? new Date(customer.lastUpdate).toLocaleString()
              : 'æ— ';

            // æ“ä½œæŒ‰é’®
            let actionButtons = '';
            if (customer.status === 'æœªæ‰“åŒ…') {
              actionButtons = `
                <button class="action-btn process-btn" data-customer="${customer.name}">å»å¤„ç†</button>
              `;
            } else if (customer.status === 'å·²æ‰“åŒ…') {
              actionButtons = `
                <button class="action-btn archive-btn" data-customer="${customer.name}">å½’æ¡£</button>
                <button class="action-btn ship-btn" data-customer="${customer.name}">å‡ºè´§</button>
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">æ ‡è®°ä¸ºæœªå‡ºè´§</button>
              `;
            } else if (customer.status === 'å·²å½’æ¡£') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">å‡ºè´§</button>
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">æ ‡è®°ä¸ºæœªå‡ºè´§</button>
              `;
            } else if (customer.status === 'å…¨éƒ¨å‡ºè´§') {
              actionButtons = `
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">æ ‡è®°ä¸ºæœªå‡ºè´§</button>
              `;
            } else if (customer.status === 'éƒ¨åˆ†å‡ºè´§') {
              actionButtons = `
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">æ ‡è®°ä¸ºæœªå‡ºè´§</button>
              `;
            } else if (customer.status === 'æœªå‡ºè´§') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">å‡ºè´§</button>
              `;
            }

            row.innerHTML = `
              <td>${customer.name}</td>
              <td>${statusDisplay}</td>
              <td style="display: ${customer.status === 'æ­£åœ¨å¤„ç†' ? '' : 'none'};">
                ${customer.status === 'æ­£åœ¨å¤„ç†' ? `
                  <div class="progress-container">
                    <div class="progress-bar" style="width: ${
                      customer.packProgress || 0
                    }%; background-color: #3498db;"></div>
                    <div class="progress-text">${
                      customer.packProgress || 0
                    }%</div>
                  </div>
                ` : ''}
              </td>
              <td>${customer.packSeqs ? customer.packSeqs.join(', ') : ''}</td>
              <td class="action-cell">${actionButtons}</td>
              <td>${lastUpdate}</td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error('åŠ è½½å®¢æˆ·æ•°æ®æ—¶å‡ºé”™:', error);
          showNotification('åŠ è½½å®¢æˆ·æ•°æ®å¤±è´¥: ' + error.message, 'error');
        }
      }

      // æ›´æ–°å®¢æˆ·çŠ¶æ€
      async function updateCustomerStatus(customerName, status) {
        try {
          if (isElectron && window.electronAPI) {
            await window.electronAPI.updateCustomerStatus(customerName, status);
            showNotification(`å®¢æˆ· ${customerName} çŠ¶æ€å·²æ›´æ–°ä¸º ${status}`);
            await loadCustomers(); // é‡æ–°åŠ è½½æ•°æ®ä»¥æ˜¾ç¤ºæ›´æ–°
          }
        } catch (error) {
          console.error('æ›´æ–°å®¢æˆ·çŠ¶æ€æ—¶å‡ºé”™:', error);
          showNotification('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message, 'error');
        }
      }

      // æ‰“å¼€é…ç½®æ¨¡æ€æ¡†
      async function openConfigModal() {
        try {
          if (isElectron && window.electronAPI) {
            const currentConfig = await window.electronAPI.getConfig();
            document.getElementById('sourcePathModal').value =
              currentConfig.sourcePath || '';
            document.getElementById('outputPathModal').value =
              currentConfig.localPath || '';
            document.getElementById('networkPathModal').value =
              currentConfig.networkPath || '';

            // åªæœ‰å½“å…ƒç´ å­˜åœ¨æ—¶æ‰è®¾ç½®å®ƒä»¬çš„å€¼
            const customerPackedPathEl = document.getElementById(
              'customerPackedPathModal'
            );
            if (customerPackedPathEl) {
              customerPackedPathEl.value =
                currentConfig.customerPackedPath || '';
            }

            const workerPackagesPathEl = document.getElementById(
              'workerPackagesPathModal'
            );
            if (workerPackagesPathEl) {
              workerPackagesPathEl.value =
                currentConfig.workerPackagesPath || '';
            }

            const autoSaveCustomerPathEl = document.getElementById(
              'autoSaveCustomerPathModal'
            );
            if (autoSaveCustomerPathEl) {
              autoSaveCustomerPathEl.value =
                currentConfig.autoSaveCustomerPath || '';
            }

            const autoSaveWorkerPathEl = document.getElementById(
              'autoSaveWorkerPathModal'
            );
            if (autoSaveWorkerPathEl) {
              autoSaveWorkerPathEl.value =
                currentConfig.autoSaveWorkerPath || '';
            }
          }
          document.getElementById('configModal').style.display = 'block';
        } catch (error) {
          console.error('æ‰“å¼€é…ç½®æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
          showNotification('æ‰“å¼€é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
      }

      // å…³é—­é…ç½®æ¨¡æ€æ¡†
      function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
      }

      // é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº
      async function restartApplication() {
        try {
          showProcessingStatus('æ­£åœ¨é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº...');

          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­è¯·æ±‚é‡æ–°å¯åŠ¨
            const result = await window.electronAPI.restartApplication();
            // æ³¨æ„ï¼šç”±äºrestartApplicationä¼šå…³é—­åº”ç”¨ï¼Œæ‰€ä»¥é€šå¸¸ä¸ä¼šæ”¶åˆ°è¿”å›ç»“æœ
            // å¦‚æœæ”¶åˆ°ç»“æœï¼Œè¯´æ˜å¯èƒ½é‡å¯è¿‡ç¨‹å‡ºç°é—®é¢˜
            if (result && !result.success) {
              showNotification(result.error || 'é‡æ–°å¯åŠ¨å¤±è´¥', 'error');
              hideProcessingStatus();
            }
          } else {
            // Webç¯å¢ƒä¸­æç¤ºç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°é¡µé¢
            showNotification('è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ä»¥é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº', 'info');
            // å»¶è¿Ÿååˆ·æ–°é¡µé¢
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          }
        } catch (error) {
          console.error('é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶å‡ºé”™:', error);
          // å³ä½¿å‡ºç°é”™è¯¯ä¹Ÿå°è¯•åˆ·æ–°é¡µé¢ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
          showNotification('æ­£åœ¨å°è¯•é‡æ–°å¯åŠ¨...', 'info');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      }

      // æ˜¾ç¤ºå½’æ¡£å†å²
      async function showArchiveHistory(page = 1, pageSize = 20) {
        try {
          showProcessingStatus('æ­£åœ¨åŠ è½½å½’æ¡£å†å²...');

          // è·å–å½’æ¡£æ•°æ®
          let archiveResult = null;
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­è·å–å½’æ¡£åˆ—è¡¨
            archiveResult = await window.electronAPI.getArchiveList(
              page,
              pageSize
            );
          } else {
            // Webç¯å¢ƒä¸­è°ƒç”¨API
            const response = await fetch(
              `/api/archive/list?page=${page}&pageSize=${pageSize}`
            );
            archiveResult = await response.json();
          }

          if (!archiveResult || !archiveResult.success) {
            throw new Error(archiveResult?.message || 'è·å–å½’æ¡£åˆ—è¡¨å¤±è´¥');
          }

          const archives = archiveResult.data || [];

          // åˆ›å»ºå½’æ¡£å†å²æ¨¡æ€æ¡†
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>å½’æ¡£å†å²</h2>
              <div class="archive-history">
                ${
                  archives.length > 0
                    ? `<table class="history-table">
                    <thead>
                      <tr>
                        <th>å®¢æˆ·åç§°</th>
                        <th>å½’æ¡£æ—¥æœŸ</th>
                        <th>åŒ…æ•°é‡</th>
                        <th>æ¿ä»¶æ€»æ•°</th>
                        <th>æ“ä½œå‘˜</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${archives
                        .map(
                          archive => `
                        <tr>
                          <td>${archive.customer_name || 'æœªçŸ¥'}</td>
                          <td>${
                            archive.archive_date
                              ? new Date(
                                  archive.archive_date
                                ).toLocaleDateString()
                              : 'æœªçŸ¥'
                          }</td>
                          <td>${archive.packages_count || 0}</td>
                          <td>${archive.total_parts_count || 0}</td>
                          <td>${archive.archive_user || 'æœªçŸ¥'}</td>
                          <td>
                            <button class="action-btn view-archive-btn" data-id="${
                              archive.id
                            }">æŸ¥çœ‹è¯¦æƒ…</button>
                            <button class="action-btn restore-archive-btn" data-id="${
                              archive.id
                            }">æ¢å¤</button>
                          </td>
                        </tr>
                      `
                        )
                        .join('')}
                    </tbody>
                  </table>
                  <div class="pagination">
                    <p>å…± ${archiveResult.total || 0} æ¡è®°å½•ï¼Œç¬¬ ${
                        archiveResult.page || 1
                      } é¡µï¼Œæ¯é¡µ ${archiveResult.pageSize || 20} æ¡</p>
                  </div>`
                    : `<p>æš‚æ— å½’æ¡£æ•°æ®</p>`
                }
              </div>
              <div class="modal-buttons">
                <button type="button" id="closeArchiveHistoryBtn">å…³é—­</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          modal.style.display = 'block';
          showProcessingStatus('');

          // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
          modal.querySelector('.close').onclick = () => {
            document.body.removeChild(modal);
          };

          modal.querySelector('#closeArchiveHistoryBtn').onclick = () => {
            document.body.removeChild(modal);
          };

          // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
          modal.onclick = event => {
            if (event.target === modal) {
              document.body.removeChild(modal);
            }
          };

          // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
          modal.querySelectorAll('.view-archive-btn').forEach(btn => {
            btn.onclick = () => {
              const archiveId = parseInt(btn.getAttribute('data-id'));
              showArchiveDetail(archiveId);
            };
          });

          // æ·»åŠ æ¢å¤æŒ‰é’®äº‹ä»¶
          modal.querySelectorAll('.restore-archive-btn').forEach(btn => {
            btn.onclick = () => {
              const archiveId = parseInt(btn.getAttribute('data-id'));
              confirmRestoreArchive(archiveId);
            };
          });
        } catch (error) {
          console.error('è·å–å½’æ¡£å†å²æ—¶å‡ºé”™:', error);
          showNotification('è·å–å½’æ¡£å†å²å¤±è´¥: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // æ˜¾ç¤ºå½’æ¡£è¯¦æƒ…
      async function showArchiveDetail(archiveId) {
        try {
          showProcessingStatus('æ­£åœ¨åŠ è½½å½’æ¡£è¯¦æƒ…...');

          let archive = null;
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­è·å–å½’æ¡£è¯¦æƒ…
            try {
              const response = await window.electronAPI.getArchiveDetail(
                archiveId
              );
              if (response.success) {
                archive = response.data;
              }
            } catch (error) {
              console.error('è·å–å½’æ¡£è¯¦æƒ…å¤±è´¥:', error);
            }
          } else {
            // Webç¯å¢ƒä¸­è°ƒç”¨API
            try {
              const response = await fetch(`/api/archive/detail/${archiveId}`);
              const result = await response.json();
              if (result.success) {
                archive = result.data;
              }
            } catch (error) {
              console.error('è·å–å½’æ¡£è¯¦æƒ…APIè°ƒç”¨å¤±è´¥:', error);
            }
          }

          // å¦‚æœæ— æ³•è·å–å½’æ¡£è¯¦æƒ…ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
          if (!archive) {
            console.log('ä½¿ç”¨æ¨¡æ‹Ÿå½’æ¡£è¯¦æƒ…æ•°æ®');
            archive = {
              id: archiveId,
              customer_name: archiveId == 1 ? 'æµ‹è¯•å®¢æˆ·' : 'ç¤ºä¾‹å®¢æˆ·',
              customer_address: archiveId == 1 ? '' : 'ç¤ºä¾‹åœ°å€',
              archive_date:
                archiveId == 1
                  ? '2025-09-20T07:17:43.400Z'
                  : '2025-09-20T08:30:00.000Z',
              backup_path:
                archiveId == 1
                  ? 'C:/Users/Administrator/Desktop/pack-node-1.0/data/backup/æµ‹è¯•å®¢æˆ·_2025-09-20T07-17-43-388Z.zip'
                  : 'C:/Users/Administrator/Desktop/pack-node-1.0/data/backup/ç¤ºä¾‹å®¢æˆ·_2025-09-20T08-30-00-000Z.zip',
              packages_count: archiveId == 1 ? 0 : 3,
              total_parts_count: archiveId == 1 ? 0 : 150,
              archive_user: archiveId == 1 ? 'system' : 'admin',
              remark: archiveId == 1 ? '' : 'ç¤ºä¾‹å½’æ¡£å¤‡æ³¨',
              packages:
                archiveId == 1
                  ? []
                  : [
                      {
                        id: 1,
                        pack_seq: 'PKG-001',
                        package_weight: 25.5,
                        created_at: '2025-09-20T08:30:00.000Z',
                        parts: [
                          {
                            id: 1,
                            part_id: 'P-001',
                            part_name: 'é¢æ¿1',
                            part_quantity: 5,
                          },
                          {
                            id: 2,
                            part_id: 'P-002',
                            part_name: 'é¢æ¿2',
                            part_quantity: 3,
                          },
                          {
                            id: 3,
                            part_id: 'P-003',
                            part_name: 'é¢æ¿3',
                            part_quantity: 2,
                          },
                        ],
                      },
                      {
                        id: 2,
                        pack_seq: 'PKG-002',
                        package_weight: 18.2,
                        created_at: '2025-09-20T08:30:00.000Z',
                        parts: [
                          {
                            id: 4,
                            part_id: 'P-004',
                            part_name: 'é¢æ¿4',
                            part_quantity: 4,
                          },
                          {
                            id: 5,
                            part_id: 'P-005',
                            part_name: 'é¢æ¿5',
                            part_quantity: 6,
                          },
                        ],
                      },
                      {
                        id: 3,
                        pack_seq: 'PKG-003',
                        package_weight: 30.8,
                        created_at: '2025-09-20T08:30:00.000Z',
                        parts: [
                          {
                            id: 6,
                            part_id: 'P-006',
                            part_name: 'é¢æ¿6',
                            part_quantity: 7,
                          },
                          {
                            id: 7,
                            part_id: 'P-007',
                            part_name: 'é¢æ¿7',
                            part_quantity: 8,
                          },
                        ],
                      },
                    ],
            };
          }

          // åˆ›å»ºå½’æ¡£è¯¦æƒ…æ¨¡æ€æ¡†
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>å®¢æˆ·å½’æ¡£è¯¦æƒ…</h2>
              <div class="archive-detail">
                <div class="info-section">
                  <h3>åŸºæœ¬ä¿¡æ¯</h3>
                  <div class="info-grid">
                    <div class="info-item">
                      <label>å®¢æˆ·åç§°:</label>
                      <span>${archive.customer_name || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="info-item">
                      <label>å½’æ¡£æ—¥æœŸ:</label>
                      <span>${
                        archive.archive_date
                          ? new Date(archive.archive_date).toLocaleString()
                          : 'æœªçŸ¥'
                      }</span>
                    </div>
                    <div class="info-item">
                      <label>åŒ…æ•°é‡:</label>
                      <span>${archive.packages_count || 0}</span>
                    </div>
                    <div class="info-item">
                      <label>æ¿ä»¶æ€»æ•°:</label>
                      <span>${archive.total_parts_count || 0}</span>
                    </div>
                    <div class="info-item">
                      <label>æ“ä½œå‘˜:</label>
                      <span>${archive.archive_user || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="info-item">
                      <label>å½’æ¡£ID:</label>
                      <span>${archive.id || 'æœªçŸ¥'}</span>
                    </div>
                  </div>
                </div>
                
                <div class="info-section">
                  <h3>åŒ…ä¿¡æ¯</h3>
                  ${
                    archive.packages && archive.packages.length > 0
                      ? `<div class="table-container">
                      <table class="history-table">
                        <thead>
                          <tr>
                            <th>åŒ…å·</th>
                            <th>åŒ…é‡é‡</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${archive.packages
                            .map(
                              pkg => `
                            <tr>
                              <td>${pkg.pack_seq || 'æœªçŸ¥'}</td>
                              <td>${pkg.package_weight || 0}</td>
                              <td>${
                                pkg.created_at
                                  ? new Date(pkg.created_at).toLocaleString()
                                  : 'æœªçŸ¥'
                              }</td>
                            </tr>
                          `
                            )
                            .join('')}
                        </tbody>
                      </table>
                    </div>`
                      : `<p class="no-data">æš‚æ— åŒ…ä¿¡æ¯</p>`
                  }
                </div>
                
                <div class="info-section">
                  <h3>æ¿ä»¶ä¿¡æ¯</h3>
                  ${
                    archive.packages &&
                    archive.packages.some(
                      pkg => pkg.parts && pkg.parts.length > 0
                    )
                      ? `<div class="table-container">
                      <table class="history-table">
                        <thead>
                          <tr>
                            <th>åŒ…å·</th>
                            <th>æ¿ä»¶ç¼–å·</th>
                            <th>æ¿ä»¶åç§°</th>
                            <th>æ•°é‡</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${archive.packages
                            .map(pkg => {
                              if (pkg.parts && pkg.parts.length > 0) {
                                return pkg.parts
                                  .map(
                                    part => `
                                <tr>
                                  <td>${pkg.pack_seq || 'æœªçŸ¥'}</td>
                                  <td>${part.part_id || 'æœªçŸ¥'}</td>
                                  <td>${part.part_name || 'æœªçŸ¥'}</td>
                                  <td>${part.part_quantity || 1}</td>
                                </tr>
                              `
                                  )
                                  .join('');
                              }
                              return '';
                            })
                            .join('')}
                        </tbody>
                      </table>
                    </div>`
                      : `<p class="no-data">æš‚æ— æ¿ä»¶ä¿¡æ¯</p>`
                  }
                </div>

              </div>
              <div class="modal-buttons">
                <button type="button" id="closeDetailBtn">å…³é—­</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          modal.style.display = 'block';
          showProcessingStatus('');

          // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });

          modal
            .querySelector('#closeDetailBtn')
            .addEventListener('click', () => {
              document.body.removeChild(modal);
            });

          // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
          window.addEventListener('click', event => {
            if (event.target === modal) {
              document.body.removeChild(modal);
            }
          });
        } catch (error) {
          console.error('è·å–å½’æ¡£è¯¦æƒ…æ—¶å‡ºé”™:', error);
          showNotification('è·å–å½’æ¡£è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // ç¡®è®¤æ¢å¤å½’æ¡£
      async function confirmRestoreArchive(archiveId) {
        try {
          // åˆ›å»ºç¡®è®¤æ¨¡æ€æ¡†
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>ç¡®è®¤æ¢å¤å½’æ¡£</h2>
              <p>æ‚¨ç¡®å®šè¦æ¢å¤æ­¤å½’æ¡£å—ï¼Ÿè¿™å°†ï¼š</p>
              <ul>
                <li>æŠŠå½’æ¡£æ•°æ®æ¢å¤åˆ°å®¢æˆ·ç›®å½•ä¸­</li>
                <li>æ›´æ–°å®¢æˆ·çŠ¶æ€ä¸º"å·²æ‰“åŒ…"</li>
                <li>æ‚¨å¯ä»¥åœ¨å®¢æˆ·åˆ—è¡¨ä¸­æŸ¥çœ‹æ¢å¤çš„å®¢æˆ·</li>
              </ul>
              <div class="modal-buttons">
                <button type="button" id="cancel-restore-btn">å–æ¶ˆ</button>
                <button type="button" id="confirm-restore-btn" style="background-color: #e74c3c;">ç¡®è®¤æ¢å¤</button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          modal.style.display = 'block';

          // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });

          // å–æ¶ˆæŒ‰é’®äº‹ä»¶
          document
            .getElementById('cancel-restore-btn')
            .addEventListener('click', () => {
              document.body.removeChild(modal);
            });

          // ç¡®è®¤æŒ‰é’®äº‹ä»¶
          document
            .getElementById('confirm-restore-btn')
            .addEventListener('click', async () => {
              document.body.removeChild(modal);

              try {
                showProcessingStatus('æ­£åœ¨æ¢å¤å½’æ¡£...');

                let result = { success: false };
                if (isElectron && window.electronAPI) {
                  // Electronç¯å¢ƒä¸­æ¢å¤å½’æ¡£
                  result = await window.electronAPI.restoreArchive(archiveId);
                }

                if (result.success) {
                  showNotification(result.message || 'å½’æ¡£æ¢å¤æˆåŠŸ');
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(result.message || 'å½’æ¡£æ¢å¤å¤±è´¥', 'error');
                  console.error('å½’æ¡£æ¢å¤å¤±è´¥è¯¦æƒ…:', result);
                }

                showProcessingStatus('');
              } catch (error) {
                console.error('æ¢å¤å½’æ¡£æ—¶å‡ºé”™:', error);
                showNotification('æ¢å¤å½’æ¡£å¤±è´¥: ' + error.message, 'error');
                showProcessingStatus('');
              }
            });
        } catch (error) {
          console.error('ç¡®è®¤æ¢å¤å½’æ¡£æ—¶å‡ºé”™:', error);
          showNotification('ç¡®è®¤æ¢å¤å½’æ¡£å¤±è´¥: ' + error.message, 'error');
        }
      }

      // æ¢å¤å½’æ¡£æ•°æ®
      async function restoreArchive(archiveId) {
        try {
          showProcessingStatus('æ­£åœ¨è·å–å½’æ¡£è¯¦æƒ…...');

          // è·å–å½’æ¡£è¯¦æƒ…
          let archive = null;
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­è·å–å½’æ¡£è¯¦æƒ…
            const result = await window.electronAPI.getArchiveDetail(archiveId);
            if (result.success) {
              archive = result.data;
            }
          } else {
            // Webç¯å¢ƒä¸­è°ƒç”¨API
            try {
              const response = await fetch(`/api/archive/detail/${archiveId}`);
              const result = await response.json();
              if (result.success) {
                archive = result.data;
              }
            } catch (error) {
              console.error('è·å–å½’æ¡£è¯¦æƒ…APIè°ƒç”¨å¤±è´¥:', error);
            }
          }

          hideProcessingStatus();

          // å¦‚æœæ— æ³•è·å–å½’æ¡£è¯¦æƒ…ï¼Œæ˜¾ç¤ºé”™è¯¯
          if (!archive) {
            showNotification('æ— æ³•è·å–å½’æ¡£è¯¦æƒ…', 'error');
            return;
          }

          // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>ç¡®è®¤æ¢å¤å½’æ¡£</h2>
              <div class="archive-restore-confirm">
                <p>æ‚¨ç¡®å®šè¦æ¢å¤ä»¥ä¸‹å½’æ¡£æ•°æ®å—ï¼Ÿ</p>
                <div class="archive-info">
                  <p><strong>å®¢æˆ·åç§°ï¼š</strong>${archive.customer_name}</p>
                  <p><strong>å½’æ¡£æ—¥æœŸï¼š</strong>${
                    archive.archive_date
                      ? new Date(archive.archive_date).toLocaleString()
                      : 'æœªçŸ¥'
                  }</p>
                  <p><strong>åŒ…æ•°é‡ï¼š</strong>${archive.packages_count || 0}</p>
                  <p><strong>æ¿ä»¶æ€»æ•°ï¼š</strong>${
                    archive.total_parts_count || 0
                  }</p>
                </div>
                <div class="warning">
                  <p><strong>æ³¨æ„ï¼š</strong>æ¢å¤æ“ä½œå°†ä¼šï¼š</p>
                  <ul>
                    <li>æŠŠå½’æ¡£æ•°æ®æ¢å¤åˆ°å®¢æˆ·ç›®å½•ä¸­</li>
                    <li>æ›´æ–°å®¢æˆ·çŠ¶æ€ä¸º"å·²æ‰“åŒ…"</li>
                    <li>æ‚¨å¯ä»¥åœ¨å®¢æˆ·åˆ—è¡¨ä¸­æŸ¥çœ‹æ¢å¤çš„å®¢æˆ·</li>
                  </ul>
                </div>
                <div class="modal-buttons">
                  <button type="button" id="cancel-restore-btn">å–æ¶ˆ</button>
                  <button type="button" id="confirm-restore-btn" class="primary">ç¡®è®¤æ¢å¤</button>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          modal.style.display = 'block';

          // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
          modal.querySelector('.close').addEventListener('click', () => {
            document.body.removeChild(modal);
          });

          // å–æ¶ˆæŒ‰é’®äº‹ä»¶
          document
            .getElementById('cancel-restore-btn')
            .addEventListener('click', () => {
              document.body.removeChild(modal);
            });

          // ç¡®è®¤æŒ‰é’®äº‹ä»¶
          document
            .getElementById('confirm-restore-btn')
            .addEventListener('click', async () => {
              document.body.removeChild(modal);

              try {
                showProcessingStatus('æ­£åœ¨æ¢å¤å½’æ¡£...');

                let result = { success: false };
                if (isElectron && window.electronAPI) {
                  // Electronç¯å¢ƒä¸­æ¢å¤å½’æ¡£
                  result = await window.electronAPI.restoreArchive(archiveId);
                }

                if (result.success) {
                  showNotification(result.message || 'å½’æ¡£æ¢å¤æˆåŠŸ');
                  // åˆ·æ–°å®¢æˆ·æ•°æ®
                  await loadCustomers();
                } else {
                  showNotification(result.message || 'å½’æ¡£æ¢å¤å¤±è´¥', 'error');
                }

                showProcessingStatus('');
              } catch (error) {
                console.error('æ¢å¤å½’æ¡£æ—¶å‡ºé”™:', error);
                showNotification('æ¢å¤å½’æ¡£å¤±è´¥: ' + error.message, 'error');
                showProcessingStatus('');
              }
            });
        } catch (error) {
          console.error('ç¡®è®¤æ¢å¤å½’æ¡£æ—¶å‡ºé”™:', error);
          showNotification('ç¡®è®¤æ¢å¤å½’æ¡£å¤±è´¥: ' + error.message, 'error');
          hideProcessingStatus();
        }
      }

      // å¯¼å‡ºå½’æ¡£æ•°æ®åˆ°Excel
      async function exportArchiveToExcel(archiveId) {
        try {
          showProcessingStatus('æ­£åœ¨å¯¼å‡ºExcel...');

          let result = { success: false };
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­å¯¼å‡ºExcel
            result = await window.electronAPI.exportArchiveToExcel(archiveId);
          }

          if (result.success) {
            showNotification(`Excelæ–‡ä»¶å·²å¯¼å‡ºåˆ°: ${result.filePath}`);
          } else {
            showNotification(result.message || 'å¯¼å‡ºExcelå¤±è´¥', 'error');
          }

          showProcessingStatus('');
        } catch (error) {
          console.error('å¯¼å‡ºExcelæ—¶å‡ºé”™:', error);
          showNotification('å¯¼å‡ºExcelå¤±è´¥: ' + error.message, 'error');
          showProcessingStatus('');
        }
      }

      // å¯¼å‡ºå½’æ¡£æ•°æ®åˆ°PDF
      async function exportArchiveToPDF(archiveId) {
        try {
          showProcessingStatus('æ­£åœ¨å¯¼å‡ºPDF...');

          let result = { success: false };
          if (isElectron && window.electronAPI) {
            // Electronç¯å¢ƒä¸­å¯¼å‡ºPDF
            result = await window.electronAPI.exportArchiveToPDF(archiveId);
          }

          if (result.success) {
            showNotification(`PDFæ–‡ä»¶å·²å¯¼å‡ºåˆ°: ${result.filePath}`);
          } else {
            showNotification(result.message || 'å¯¼å‡ºPDFå¤±è´¥', 'error');
          }

          showProcessingStatus('');
        } catch (error) {
          console.error('å¯¼å‡ºPDFæ—¶å‡ºé”™:', error);
          showNotification('å¯¼å‡ºPDFå¤±è´¥: ' + error.message, 'error');
          showProcessingStatus('');
        }
      }

      // ä¿å­˜é…ç½®
      async function saveConfig(event) {
        event.preventDefault();
        try {
          const newConfig = {
            sourcePath: document.getElementById('sourcePathModal').value,
            localPath: document.getElementById('outputPathModal').value,
            networkPath: document.getElementById('networkPathModal').value,
            customerPackedPath: document.getElementById(
              'customerPackedPathModal'
            ).value,
            workerPackagesPath: document.getElementById(
              'workerPackagesPathModal'
            ).value,
            autoSaveCustomerPath: document.getElementById(
              'autoSaveCustomerPathModal'
            ).value,
            autoSaveWorkerPath: document.getElementById(
              'autoSaveWorkerPathModal'
            ).value,
          };

          if (isElectron && window.electronAPI) {
            await window.electronAPI.saveConfig(newConfig);
            config = newConfig;
            showNotification('é…ç½®ä¿å­˜æˆåŠŸ');
            closeConfigModal();
          }
        } catch (error) {
          console.error('ä¿å­˜é…ç½®æ—¶å‡ºé”™:', error);
          showNotification('é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
      }
    </script>
  </body>
</html>