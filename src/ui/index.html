<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>客户数据打包管理系统</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #3498db;
        color: white;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
      }

      .control-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        margin-bottom: 15px;
        align-items: center;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .run-button {
        background-color: #27ae60;
      }

      .run-button:hover {
        background-color: #229954;
      }

      .stop-button {
        background-color: #e74c3c;
      }

      .stop-button:hover {
        background-color: #c0392b;
      }

      .path-config {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 3px;
        margin-top: 15px;
        border: 1px solid #eee;
      }

      .path-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
      }

      .path-label {
        width: 120px;
        font-weight: bold;
      }

      .path-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      /* 客户状态样式 */
      .status-not-packed {
        color: #95a5a6; /* 灰色 */
      }

      .status-in-progress {
        color: #3498db; /* 蓝色 */
      }

      .status-packed {
        color: #f1c40f; /* 黄色 */
      }

      .status-archived {
        color: #9b59b6; /* 紫色 */
      }

      .status-shipped {
        color: #2ecc71; /* 绿色 */
      }

      .status-not-shipped {
        color: #e67e22; /* 橙色 */
      }

      /* 操作按钮样式 */
      .action-btn {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .archive-btn {
        background-color: #9b59b6;
        color: white;
      }

      .archive-btn:hover {
        background-color: #8e44ad;
      }

      .ship-btn {
        background-color: #2ecc71;
        color: white;
      }

      .ship-btn:hover {
        background-color: #27ae60;
      }

      .not-shipped-btn {
        background-color: #e67e22;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #d35400;
      }

      .customers-table {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #34495e;
        color: white;
        font-weight: bold;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .status-processing {
        color: #f39c12;
        font-weight: bold;
      }

      .status-completed {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .status-not-packed {
        color: #888888;
        font-weight: bold;
      }

      .status-in-progress {
        color: #2196f3;
        font-weight: bold;
      }

      .status-packed {
        color: #ffc107;
        font-weight: bold;
      }

      .status-archived {
        color: #9c27b0;
        font-weight: bold;
      }

      .status-shipped {
        color: #4caf50;
        font-weight: bold;
      }

      .status-not-shipped {
        color: #ff9800;
        font-weight: bold;
      }

      /* 进度条样式 */
      .progress-container {
        position: relative;
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: #333;
      }

      /* 操作按钮样式 */
      .action-cell {
        white-space: nowrap;
      }

      .action-btn {
        margin: 0 3px;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .archive-btn {
        background-color: #9c27b0;
        color: white;
      }

      .archive-btn:hover {
        background-color: #7b1fa2;
      }

      .ship-btn {
        background-color: #4caf50;
        color: white;
      }

      .ship-btn:hover {
        background-color: #388e3c;
      }

      .not-shipped-btn {
        background-color: #ff9800;
        color: white;
      }

      .not-shipped-btn:hover {
        background-color: #f57c00;
      }

      .path-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .footer {
        margin-top: 20px;
        text-align: center;
        color: #7f8c8d;
        font-size: 12px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        color: white;
        background-color: #27ae60;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #27ae60;
      }

      .status-stopped {
        background-color: #e74c3c;
      }

      /* 配置区域样式 */
      .config-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .config-section:last-child {
        border-bottom: none;
      }

      .config-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
      }

      /* 模态框按钮区域 */
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* 配置按钮样式 */
      .config-button {
        background-color: #9b59b6;
      }

      .config-button:hover {
        background-color: #8e44ad;
      }

      .auto-save-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        margin-left: auto;
      }

      .auto-save-toggle input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* 处理状态显示 */
      .processing-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        background-color: #f8f9fa;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>客户数据打包管理系统</h1>
    </div>

    <div class="control-panel">
      <div class="button-group">
        <button id="viewDataBtn" title="查看自动保存数据的存储位置">
          查看自动保存路径
        </button>
        <button id="refreshBtn">刷新数据</button>
        <button id="configBtn" class="config-button">打开路径配置</button>
      </div>

      <div id="processingStatus" class="processing-status"></div>
    </div>

    <div class="customers-table">
      <h2 style="padding: 20px 20px 0 20px; text-align: center">
        客户信息和打包状态
      </h2>
      <table id="customersTable">
        <thead>
          <tr>
            <th>客户名称</th>
            <th>客户状态</th>
            <th>打包进度</th>
            <th>包号</th>
            <th>操作</th>
            <th>最后更新时间</th>
          </tr>
        </thead>
        <tbody>
          <!-- 数据将通过JavaScript动态填充 -->
        </tbody>
      </table>
    </div>
    <!-- 配置弹出层 -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>路径配置</h2>
        <form id="configForm">
          <div class="config-section">
            <h3>基本路径配置</h3>
            <div class="path-row">
              <span class="path-label">源地址:</span>
              <input
                type="text"
                id="sourcePathModal"
                class="path-input"
                placeholder="请输入源地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">输出地址:</span>
              <input
                type="text"
                id="outputPathModal"
                class="path-input"
                placeholder="请输入输出地址"
              />
            </div>
            <div class="path-row">
              <span class="path-label">网络路径:</span>
              <input
                type="text"
                id="networkPathModal"
                class="path-input"
                placeholder="网络同步路径（可选）"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>打包数据路径</h3>
            <div class="path-row">
              <span class="path-label">客户已打包数据:</span>
              <input
                type="text"
                id="customerPackedPathModal"
                class="path-input"
                placeholder="客户已打包数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">工人打包数据:</span>
              <input
                type="text"
                id="workerPackagesPathModal"
                class="path-input"
                placeholder="工人打包数据路径"
              />
            </div>
          </div>
          <div class="config-section">
            <h3>自动保存路径</h3>
            <div class="path-row">
              <span class="path-label">自动保存客户数据:</span>
              <input
                type="text"
                id="autoSaveCustomerPathModal"
                class="path-input"
                placeholder="自动保存客户数据路径"
              />
            </div>
            <div class="path-row">
              <span class="path-label">自动保存工人数据:</span>
              <input
                type="text"
                id="autoSaveWorkerPathModal"
                class="path-input"
                placeholder="自动保存工人数据路径"
              />
            </div>
          </div>
          <div class="modal-buttons">
            <button type="submit" id="saveModalConfigBtn">保存配置</button>
            <button type="button" id="cancelModalBtn">取消</button>
          </div>
        </form>
      </div>
    </div>
    <div class="notification" id="notification"></div>

    <div class="footer">
      <p>客户数据打包管理系统 v1.0</p>
    </div>

    <script>
      // 检查是否在 Electron 环境中运行
      const isElectron = !!window.electronAPI;

      // 全局变量
      let isRunning = false;
      let config = {};

      // 显示通知
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor =
          type === 'success' ? '#27ae60' : '#e74c3c';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // 显示处理状态
      function showProcessingStatus(message, type = 'info') {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = message;
        statusElement.style.display = 'block';

        // 根据类型设置背景色
        switch (type) {
          case 'error':
            statusElement.style.backgroundColor = '#fceaea';
            statusElement.style.color = '#c0392b';
            break;
          case 'success':
            statusElement.style.backgroundColor = '#eafaf1';
            statusElement.style.color = '#27ae60';
            break;
          default:
            statusElement.style.backgroundColor = '#f8f9fa';
            statusElement.style.color = '#333';
        }
      }

      // 隐藏处理状态
      function hideProcessingStatus() {
        const statusElement = document.getElementById('processingStatus');
        statusElement.style.display = 'none';
      }

      // 查看自动保存路径按钮点击事件
      async function viewDataBtnClick() {
        try {
          // 确保获取最新配置
          if (!config || Object.keys(config).length === 0) {
            await loadConfigToModal();
          }

          const path = config.customerPackedPath;
          if (!path) {
            showNotification('未配置自动保存路径', 'error');
            return;
          }

          if (isElectron) {
            // 在 Electron 环境中打开路径
            const result = await window.electronAPI.openDirectory(path);
            if (result.success) {
              showNotification(
                '已成功打开文件夹: ' + abbreviatePath(path),
                'success'
              );
            } else {
              showNotification('打开文件夹失败: ' + result.error, 'error');
            }
          } else {
            // Web 环境中通过服务器打开路径
            showNotification('正在打开路径: ' + abbreviatePath(path));
            const response = await fetch(
              '/open-folder?path=' + encodeURIComponent(path)
            );
            const result = await response.text();

            if (response.ok) {
              showNotification(
                '已成功打开文件夹: ' + abbreviatePath(path),
                'success'
              );
            } else {
              showNotification('打开文件夹失败: ' + result, 'error');
            }
          }
        } catch (error) {
          console.error('打开路径出错:', error);
          showNotification('打开路径出错: ' + error.message, 'error');
        }
      }

      // 刷新数据按钮点击事件
      async function refreshBtnClick() {
        await loadCustomers();
        showNotification('数据已刷新');
      }

      // 检查路径配置
      function checkPaths() {
        const sourcePath = document
          .getElementById('sourcePathModal')
          .value.trim();
        const outputPath = document
          .getElementById('outputPathModal')
          .value.trim();

        if (!sourcePath || !outputPath) {
          showNotification('请先配置源地址和输出地址', 'error');
          return false;
        }

        return true;
      }

      // 加载配置到弹出层表单
      async function loadConfigToModal() {
        try {
          if (isElectron) {
            config = await window.electronAPI.getConfig();
          } else {
            const response = await fetch('/api/config');
            if (response.ok) {
              config = await response.json();
            } else {
              showNotification('加载配置失败', 'error');
              return;
            }
          }

          document.getElementById('sourcePathModal').value =
            config.sourcePath || '';
          document.getElementById('outputPathModal').value =
            config.localPath || '';
          document.getElementById('networkPathModal').value =
            config.networkPath || '';
          document.getElementById('customerPackedPathModal').value =
            config.customerPackedPath || '';
          document.getElementById('workerPackagesPathModal').value =
            config.workerPackagesPath || '';
          // 添加新的自动保存路径配置项
          document.getElementById('autoSaveCustomerPathModal').value =
            config.autoSaveCustomerPath || '';
          document.getElementById('autoSaveWorkerPathModal').value =
            config.autoSaveWorkerPath || '';
        } catch (error) {
          console.error('加载配置出错:', error);
          showNotification('加载配置出错: ' + error.message, 'error');
        }
      }

      // 获取运行状态
      async function getRunStatus() {
        // 在Electron环境中，运行状态由UI控制
        if (!isElectron) {
          try {
            const response = await fetch('/api/status');
            if (response.ok) {
              const status = await response.json();
              updateRunStatus(status.running);
            }
          } catch (error) {
            console.error('获取运行状态出错:', error);
          }
        }
      }

      // 页面加载完成后获取客户数据
      document.addEventListener('DOMContentLoaded', async () => {
        await loadCustomers();
        await loadConfigToModal();

        // 在Electron环境中注册事件监听器
        if (isElectron) {
          // 监听处理状态更新
          window.electronAPI.onProcessingStatus(data => {
            switch (data.status) {
              case 'started':
                showProcessingStatus('处理程序已启动...');
                break;
              case 'completed':
                showProcessingStatus(
                  '处理完成: 成功处理 ' + data.result.successCount + ' 个客户',
                  'success'
                );
                // 刷新客户数据
                loadCustomers();
                break;
              case 'error':
                showProcessingStatus('处理出错: ' + data.error, 'error');
                break;
              case 'stopped':
                hideProcessingStatus();
                break;
            }
          });

          // 监听未捕获的异常
          window.electronAPI.onUncaughtError(data => {
            console.error('未捕获的异常:', data);
            showNotification('程序出错: ' + data.message, 'error');
          });

          // 监听未处理的Promise拒绝
          window.electronAPI.onUnhandledRejection(data => {
            console.error('未处理的Promise拒绝:', data);
            showNotification('程序出错: ' + data.reason, 'error');
          });
        }
      });

      // 刷新按钮事件
      document
        .getElementById('refreshBtn')
        .addEventListener('click', async () => {
          await loadCustomers();
          showNotification('数据已刷新');
        });

      // 从源路径加载客户数据
      async function loadCustomersFromSource() {
        try {
          // 获取配置
          let config;
          if (isElectron) {
            config = await window.electronAPI.getConfig();
          } else {
            const response = await fetch('/api/config');
            config = await response.json();
          }

          // 检查源路径是否存在
          const sourcePath = config.sourcePath;
          if (!sourcePath) {
            showNotification('未配置源路径', 'error');
            return [];
          }

          // 读取源路径中的客户目录
          let customerDirs = [];
          try {
            if (isElectron) {
              // 在Electron环境中，通过IPC获取客户数据
              const result = await window.electronAPI.getCustomers();
              if (result.success) {
                customerDirs = result.customers.map(customer => customer.name);
              } else {
                showNotification('获取客户数据失败: ' + result.error, 'error');
                return [];
              }
            } else {
              // 在Web环境中，通过API获取客户目录
              const response = await fetch('/api/customers/source');
              const customers = await response.json();
              customerDirs = customers.map(customer => customer.name);
            }
          } catch (error) {
            console.error('读取客户目录出错:', error);
            showNotification('读取客户目录出错: ' + error.message, 'error');
            return [];
          }

          // 处理每个客户目录
          const customers = [];
          for (const dir of customerDirs) {
            try {
              // 解析客户名称（从目录名中提取）
              let customerName = dir.replace(/^\d{6}_/, '').replace(/#$/, '');

              // 如果直接使用客户名称找不到目录，尝试使用原始目录名
              let customerDirName = dir;
              let customerDirPath = path.join(sourcePath, customerDirName);

              // 如果目录不存在，尝试使用客户名称构建目录名
              if (
                !fs.existsSync(customerDirPath) ||
                !fs.statSync(customerDirPath).isDirectory()
              ) {
                customerDirName = `250901_${customerName}#`;
                customerDirPath = path.join(sourcePath, customerDirName);

                // 如果仍然不存在，尝试查找匹配的目录
                if (
                  !fs.existsSync(customerDirPath) ||
                  !fs.statSync(customerDirPath).isDirectory()
                ) {
                  const dirs = fs.readdirSync(sourcePath).filter(d => {
                    const fullPath = path.join(sourcePath, d);
                    return (
                      fs.statSync(fullPath).isDirectory() &&
                      d.includes(customerName)
                    );
                  });

                  if (dirs.length > 0) {
                    customerDirName = dirs[0];
                    customerDirPath = path.join(sourcePath, customerDirName);
                  }
                }
              }

              // 在Electron环境中，通过IPC获取客户详细信息
              let customerInfo = {
                status: '未打包',
                packProgress: 0,
                packSeqs: [],
                lastUpdate: new Date().toISOString(),
              };

              if (isElectron) {
                // 使用客户名称获取详细信息
                const result = await window.electronAPI.getCustomerDetails(
                  customerName
                );
                if (result.success) {
                  customerInfo = result.details;
                } else {
                  // 如果失败，尝试使用原始目录名
                  const originalResult =
                    await window.electronAPI.getCustomerDetails(
                      customerDirName
                    );
                  if (originalResult.success) {
                    customerInfo = originalResult.details;
                  }
                }
              } else {
                // 在Web环境中，通过API获取客户详细信息
                try {
                  const response = await fetch(
                    `/api/customers/${encodeURIComponent(customerName)}/details`
                  );
                  if (response.ok) {
                    customerInfo = await response.json();
                  }
                } catch (error) {
                  // 如果失败，尝试使用原始目录名
                  try {
                    const response = await fetch(
                      `/api/customers/${encodeURIComponent(
                        customerDirName
                      )}/details`
                    );
                    if (response.ok) {
                      customerInfo = await response.json();
                    }
                  } catch (error) {
                    console.error(
                      `获取客户 ${customerName} 详细信息出错:`,
                      error
                    );
                  }
                }
              }

              // 添加到客户列表
              customers.push({
                name: customerName,
                status: customerInfo.status || '未打包',
                packProgress: customerInfo.packProgress || 0,
                packSeqs: customerInfo.packSeqs || [],
                lastUpdate: customerInfo.lastUpdate || new Date().toISOString(),
              });
            } catch (error) {
              console.error(`处理客户目录 ${dir} 出错:`, error);
              // 即使出错也添加客户，但使用默认值
              customers.push({
                name: customerName,
                status: '未知',
                packProgress: 0,
                packSeqs: [],
                lastUpdate: new Date().toISOString(),
              });
            }
          }

          return customers;
        } catch (error) {
          console.error('加载客户数据出错:', error);
          showNotification('加载客户数据出错: ' + error.message, 'error');
          return [];
        }
      }

      // 加载客户数据
      async function loadCustomers() {
        try {
          // 从数据库获取客户数据
          let customers;
          if (isElectron) {
            // 在Electron环境中，通过IPC获取客户数据
            customers = await window.electronAPI.getCustomers();
          } else {
            // 在Web环境中，通过API获取客户数据
            const response = await fetch('/api/customers');
            customers = await response.json();
          }

          // 如果是Electron环境且返回的是对象（包含success属性），提取customers数组
          if (
            isElectron &&
            customers &&
            typeof customers === 'object' &&
            customers.success
          ) {
            customers = customers.customers || [];
          }

          const tbody = document.querySelector('#customersTable tbody');
          tbody.innerHTML = '';

          if (!customers || customers.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td colspan="6" style="text-align: center; font-style: italic; color: #7f8c8d;">
                            暂无客户数据
                        </td>
                    `;
            tbody.appendChild(row);
            return;
          }

          customers.forEach(customer => {
            const row = document.createElement('tr');
            const lastUpdate = customer.lastUpdate
              ? new Date(customer.lastUpdate).toLocaleDateString()
              : '未知';

            // 状态样式处理
            let statusClass = '';
            let statusColor = '';
            let statusText = customer.status || '未知';

            // 使用客户状态管理器中的状态和颜色
            if (customer.status === '未打包') {
              statusClass = 'status-not-packed';
              statusColor = '#95a5a6'; // 灰色
            } else if (customer.status === '正在处理') {
              statusClass = 'status-in-progress';
              statusColor = '#2196F3'; // 蓝色
            } else if (customer.status === '已打包') {
              statusClass = 'status-packed';
              statusColor = '#FFC107'; // 黄色
            } else if (customer.status === '已归档') {
              statusClass = 'status-archived';
              statusColor = '#9C27B0'; // 紫色
            } else if (customer.status === '已出货') {
              statusClass = 'status-shipped';
              statusColor = '#4CAF50'; // 绿色
            } else if (customer.status === '未出货') {
              statusClass = 'status-not-shipped';
              statusColor = '#FF9800'; // 橙色
            }

            // 状态样式处理（已在上面处理）
            let packProgress = customer.packProgress || 0;

            // 操作按钮
            let actionButtons = '';
            if (customer.status === '已打包') {
              actionButtons = `
                <button class="action-btn archive-btn" data-customer="${customer.name}">归档</button>
              `;
            } else if (customer.status === '已归档') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">出货</button>
                <button class="action-btn not-shipped-btn" data-customer="${customer.name}">标记为未出货</button>
              `;
            } else if (customer.status === '未出货') {
              actionButtons = `
                <button class="action-btn ship-btn" data-customer="${customer.name}">出货</button>
              `;
            }

            row.innerHTML = `
                        <td>${customer.name || ''}</td>
                        <td class="status-cell ${statusClass}" style="color: ${statusColor};">${statusText}</td>
                        <td>
                          <div class="progress-container">
                            <div class="progress-bar" style="width: ${packProgress}%; background-color: ${statusColor};"></div>
                            <span class="progress-text">${packProgress}%</span>
                          </div>
                        </td>
                        <td>${
                          Array.isArray(customer.packSeqs)
                            ? customer.packSeqs.join(', ')
                            : customer.packSeqs || '无'
                        }</td>
                        <td class="action-cell">${actionButtons}</td>
                        <td>${lastUpdate}</td>
                    `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('加载客户数据失败:', error);
          showNotification('加载数据失败: ' + error.message, 'error');
        }
      }

      // 缩短路径显示
      function abbreviatePath(fullPath) {
        if (!fullPath) return '';

        // 只显示路径的最后两个部分
        const parts = fullPath.split(/[/\\]/);
        if (parts.length <= 2) {
          return fullPath;
        }
        return `...${parts[parts.length - 2]}/${parts[parts.length - 1]}`;
      }

      // 弹出层相关逻辑
      document
        .getElementById('configBtn')
        .addEventListener('click', function () {
          // 打开弹出层前，先加载当前配置到弹出层表单
          loadConfigToModal();
          document.getElementById('configModal').style.display = 'block';
        });

      document.querySelector('.close').addEventListener('click', function () {
        document.getElementById('configModal').style.display = 'none';
      });

      // 取消按钮事件
      document
        .getElementById('cancelModalBtn')
        .addEventListener('click', function () {
          document.getElementById('configModal').style.display = 'none';
        });

      window.onclick = function (event) {
        const modal = document.getElementById('configModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };

      // 配置表单提交事件
      document
        .getElementById('configForm')
        .addEventListener('submit', function (e) {
          e.preventDefault();
          saveModalConfig();
        });

      // 保存弹出层中的配置
      async function saveModalConfig() {
        try {
          // 添加保存确认提示
          if (!confirm('确定要保存当前配置吗？')) {
            showNotification('保存操作已取消');
            return;
          }

          const newConfig = {
            sourcePath: document.getElementById('sourcePathModal').value.trim(),
            localPath: document.getElementById('outputPathModal').value.trim(),
            networkPath: document
              .getElementById('networkPathModal')
              .value.trim(),
            customerPackedPath: document
              .getElementById('customerPackedPathModal')
              .value.trim(),
            workerPackagesPath: document
              .getElementById('workerPackagesPathModal')
              .value.trim(),
            autoSaveCustomerPath: document
              .getElementById('autoSaveCustomerPathModal')
              .value.trim(),
            autoSaveWorkerPath: document
              .getElementById('autoSaveWorkerPathModal')
              .value.trim(),
          };

          let result;
          if (isElectron) {
            result = await window.electronAPI.saveConfig(newConfig);
          } else {
            const response = await fetch('/api/config', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(newConfig),
            });
            result = await response.json();
          }

          if (result.success) {
            showNotification('配置已保存');
            document.getElementById('configModal').style.display = 'none';
          } else {
            showNotification(
              '保存配置失败: ' + (result.error || '未知错误'),
              'error'
            );
          }
        } catch (error) {
          console.error('保存配置出错:', error);
          showNotification('保存配置出错: ' + error.message, 'error');
        }
      }

      // 按钮事件处理
      document
        .getElementById('viewDataBtn')
        .addEventListener('click', async function () {
          try {
            // 确保获取最新配置
            if (!config || Object.keys(config).length === 0) {
              await loadConfigToModal();
            }

            // 从配置中获取保存路径
            const workerBackupPath =
              config.workerPackagesPath ||
              'D:/backup_data/backup/backup/worker';
            const customerBackupPath =
              config.customerPackedPath ||
              'D:/backup_data/backup/backup/customer';

            // 创建一个简单的选择对话框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
          `;

            const overlay = document.createElement('div');
            overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
          `;

            const title = document.createElement('h3');
            title.textContent = '请选择要打开的文件夹';
            dialog.appendChild(title);

            const btn1 = document.createElement('button');
            btn1.textContent = '客户数据文件路径';
            btn1.style.cssText =
              'margin: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;';
            btn1.onclick = async function () {
              // 在 Electron 环境中打开客户数据文件路径
              if (isElectron) {
                const result = await window.electronAPI.openDirectory(
                  customerBackupPath
                );
                if (result.success) {
                  showNotification(
                    '已成功打开文件夹: ' + abbreviatePath(customerBackupPath),
                    'success'
                  );
                } else {
                  showNotification('打开文件夹失败: ' + result.error, 'error');
                }
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              } else {
                // 发送请求到服务器打开客户数据文件路径
                try {
                  const response = await fetch(
                    '/open-folder?path=' +
                      encodeURIComponent(customerBackupPath)
                  );
                  const message = await response.text();

                  if (response.ok) {
                    showNotification(message);
                  } else {
                    showNotification('打开文件夹失败: ' + message, 'error');
                  }
                  document.body.removeChild(dialog);
                  document.body.removeChild(overlay);
                } catch (err) {
                  showNotification('无法打开文件夹：' + err.message, 'error');
                  document.body.removeChild(dialog);
                  document.body.removeChild(overlay);
                }
              }
            };
            dialog.appendChild(btn1);

            const btn2 = document.createElement('button');
            btn2.textContent = '工人打包文件路径';
            btn2.style.cssText =
              'margin: 10px; padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;';
            btn2.onclick = async function () {
              // 在 Electron 环境中打开工人打包文件路径
              if (isElectron) {
                const result = await window.electronAPI.openDirectory(
                  workerBackupPath
                );
                if (result.success) {
                  showNotification(
                    '已成功打开文件夹: ' + abbreviatePath(workerBackupPath),
                    'success'
                  );
                } else {
                  showNotification('打开文件夹失败: ' + result.error, 'error');
                }
                document.body.removeChild(dialog);
                document.body.removeChild(overlay);
              } else {
                // 发送请求到服务器打开工人打包文件路径
                try {
                  const response = await fetch(
                    '/open-folder?path=' + encodeURIComponent(workerBackupPath)
                  );
                  const message = await response.text();

                  if (response.ok) {
                    showNotification(message);
                  } else {
                    showNotification('打开文件夹失败: ' + message, 'error');
                  }
                  document.body.removeChild(dialog);
                  document.body.removeChild(overlay);
                } catch (err) {
                  showNotification('无法打开文件夹：' + err.message, 'error');
                  document.body.removeChild(dialog);
                  document.body.removeChild(overlay);
                }
              }
            };
            dialog.appendChild(btn2);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.style.cssText =
              'margin: 10px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;';
            cancelBtn.onclick = function () {
              document.body.removeChild(dialog);
              document.body.removeChild(overlay);
            };
            dialog.appendChild(cancelBtn);

            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
          } catch (error) {
            console.error('打开路径出错:', error);
            showNotification('打开路径出错: ' + error.message, 'error');
          }
        });

      // 添加操作按钮的事件处理
      document.addEventListener('DOMContentLoaded', () => {
        // 归档按钮事件
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('archive-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            if (confirm(`确定要归档客户 ${customerName} 吗？`)) {
              try {
                let result;
                if (isElectron) {
                  // Electron环境中调用归档功能
                  result = await window.electronAPI.archiveCustomer(
                    customerName
                  );
                } else {
                  // Web环境中调用API
                  const response = await fetch(
                    `/api/customers/${encodeURIComponent(
                      customerName
                    )}/archive`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        remark: '通过界面归档',
                      }),
                    }
                  );
                  result = await response.json();
                }

                if (result.success) {
                  showNotification(`客户 ${customerName} 归档成功`, 'success');
                  // 刷新客户数据
                  await loadCustomers();
                } else {
                  showNotification(`归档失败: ${result.message}`, 'error');
                }
              } catch (error) {
                console.error('归档客户出错:', error);
                showNotification(`归档客户出错: ${error.message}`, 'error');
              }
            }
          }
        });

        // 出货按钮事件
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('ship-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            if (confirm(`确定要出货客户 ${customerName} 吗？`)) {
              try {
                let result;
                if (isElectron) {
                  // Electron环境中调用出货功能
                  result = await window.electronAPI.shipCustomer(customerName);
                } else {
                  // Web环境中调用API
                  const response = await fetch(
                    `/api/customers/${encodeURIComponent(customerName)}/ship`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        remark: '通过界面出货',
                      }),
                    }
                  );
                  result = await response.json();
                }

                if (result.success) {
                  showNotification(`客户 ${customerName} 出货成功`, 'success');
                  // 刷新客户数据
                  await loadCustomers();
                } else {
                  showNotification(`出货失败: ${result.message}`, 'error');
                }
              } catch (error) {
                console.error('出货客户出错:', error);
                showNotification(`出货客户出错: ${error.message}`, 'error');
              }
            }
          }
        });

        // 标记为未出货按钮事件
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('not-shipped-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            if (confirm(`确定要将客户 ${customerName} 标记为未出货吗？`)) {
              try {
                let result;
                if (isElectron) {
                  // Electron环境中调用标记功能
                  result = await window.electronAPI.markCustomerNotShipped(
                    customerName
                  );
                } else {
                  // Web环境中调用API
                  const response = await fetch(
                    `/api/customers/${encodeURIComponent(
                      customerName
                    )}/mark-not-shipped`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        remark: '通过界面标记为未出货',
                      }),
                    }
                  );
                  result = await response.json();
                }

                if (result.success) {
                  showNotification(
                    `客户 ${customerName} 已标记为未出货`,
                    'success'
                  );
                  // 刷新客户数据
                  await loadCustomers();
                } else {
                  showNotification(`标记失败: ${result.message}`, 'error');
                }
              } catch (error) {
                console.error('标记客户为未出货出错:', error);
                showNotification(
                  `标记客户为未出货出错: ${error.message}`,
                  'error'
                );
              }
            }
          }
        });

        // 检查状态按钮事件
        document.addEventListener('click', async event => {
          if (event.target.classList.contains('check-status-btn')) {
            const customerName = event.target.getAttribute('data-customer');
            try {
              let result;
              if (isElectron) {
                // Electron环境中调用检查功能
                result = await window.electronAPI.checkCustomerStatus(
                  customerName
                );
              } else {
                // Web环境中调用API
                const response = await fetch(
                  `/api/customers/${encodeURIComponent(
                    customerName
                  )}/check-status`,
                  {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );
                result = await response.json();
              }

              if (result.success) {
                showNotification(
                  `客户 ${customerName} 状态: ${result.status}, 打包进度: ${result.packProgress}%`,
                  'info'
                );
                // 刷新客户数据
                await loadCustomers();
              } else {
                showNotification(`检查状态失败: ${result.message}`, 'error');
              }
            } catch (error) {
              console.error('检查客户状态出错:', error);
              showNotification(`检查客户状态出错: ${error.message}`, 'error');
            }
          }
        });
      });
    </script>
  </body>
</html>
