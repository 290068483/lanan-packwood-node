# 补件功能模块开发 TODO 列表

## 1. 概述

根据最新的业务需求，需要开发补件处理功能模块，包括补件状态管理、XML 生成、界面展示等功能。
补件功能是系统自动完成的，不需要前端界面。系统在读取源文件时，如果有补件目录，会触发补件处理流程：
读取补件xml，提取补件的uid查询数据库中客户的uid，然后根据出货状态来处理补件。

## 2. 开发目标

- 实现补件状态管理（无补件、部分补件、全部补件），无补件状态不需要额外显示，默认为无补件
- 开发补件 XML 生成和处理逻辑
- 实现补件状态与出货状态的关联逻辑
- 提供 API 接口支持补件操作
- 系统自动处理补件流程，无需前端界面

## 3. 具体任务

### 3.1 核心功能开发

#### 3.1.1 补件状态管理模块 (src/utils/replacement-manager.js)

- [x] 创建补件状态枚举（none, partial, full）
- [x] 实现补件状态验证逻辑
- [x] 开发补件状态计算函数
- [x] 实现补件状态更新逻辑

#### 3.1.2 补件 XML 处理模块 (src/utils/replacement-xml-generator.js)

- [x] 创建补件 XML 生成器
- [ ] 实现未出货状态下的 XML 合并逻辑
- [ ] 实现已出货状态下的新 XML 生成逻辑
- [ ] 确保补件 XML 包含完整客户信息
  - 需包含客户 ID、名称、地址、联系人、联系方式等信息
    - 需使用客户信息填充 XML 模板
    - 用 xml 的 uid 去查找客户信息
- [ ] 添加补件标识字段

#### 3.1.3 补件数据模型 (src/database/models/replacement.js)

- [x] 定义补件数据结构
- [x] 实现补件数据的持久化存储
- [x] 开发补件数据查询接口

### 3.2 API 接口开发 (src/api/replacement-api.js)

- [x] 创建补件相关 API 路由
- [x] 实现标记补件接口
- [x] 实现生成补件 XML 接口
- [x] 实现补件完成接口
- [x] 实现补件状态查询接口

### 3.3 业务逻辑集成

#### 3.3.1 状态管理器集成

- [x] 更新客户状态管理器，添加补件状态支持
- [x] 实现出货状态与补件状态的关联逻辑
- [x] 确保状态转换规则符合业务要求

#### 3.3.2 数据管理器集成

- [x] 更新数据管理器，支持补件数据存储
- [x] 实现补件数据的增删改查操作

### 3.4 自动补件处理模块 (src/services/replacement-processor.js)

- [x] 创建自动补件处理服务
- [x] 实现补件目录监控
- [x] 开发补件 XML 解析功能
- [x] 实现根据 UID 查询客户信息
- [x] 根据出货状态处理补件逻辑
- [x] 实现补件处理日志记录

### 3.5 配置和工具

#### 3.5.1 配置文件

- [ ] 补件文件在源路径中，当然可能不存在补文件
- [ ] 配置补件 XML 输出路径
- [ ] 设置补件文件命名规则

#### 3.5.2 工具函数

- [ ] 开发补件状态计算工具
- [ ] 实现补件 XML 验证工具
- [ ] 创建补件数据处理工具

## 4. 集成任务

### 4.1 与现有系统集成

- [ ] 确保补件功能与打包状态兼容
- [ ] 验证补件功能与出货状态的正确关联
- [ ] 确保补件功能不影响归档操作
- [ ] 集成日志记录功能

### 4.2 数据流集成

- [ ] 实现补件数据与客户数据的关联
- [ ] 确保补件状态在系统中正确传递
- [ ] 验证补件 XML 生成与现有 XML 处理流程兼容

## 5. 测试任务

### 5.1 单元测试

- [ ] 补件状态管理模块单元测试
- [ ] 补件 XML 生成器单元测试
- [ ] 补件 API 接口单元测试
- [ ] 数据模型单元测试

### 5.2 集成测试

- [ ] 补件状态与出货状态集成测试
- [ ] 补件 XML 生成与处理流程测试
- [ ] API 接口集成测试

### 5.3 业务流程测试

- [ ] 未出货状态补件处理流程测试
- [ ] 已出货状态补件处理流程测试
- [ ] 补件完成流程测试
- [ ] 异常情况处理测试

## 6. 文档任务

- [ ] 编写补件功能设计文档
- [ ] 编写 API 接口文档