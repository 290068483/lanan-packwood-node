# 出货功能模块设计文档

## 1. 概述

出货功能模块是客户状态管理系统的重要组成部分，用于管理已打包客户的出货状态。该模块提供了完整的出货流程管理，包括全部出货、部分出货和未出货状态的标记。

## 2. 功能说明

### 2.1 全部出货 (Ship Customer)

将已打包的客户标记为全部出货状态。

**前提条件：**
- 客户状态必须为"已打包"或"正在处理"

**操作流程：**
1. 验证客户状态
2. 更新客户状态为"已出货"
3. 记录出货时间
4. 添加状态变更历史记录

### 2.2 部分出货 (Partial Ship Customer)

将已打包的客户标记为部分出货状态。

**前提条件：**
- 客户状态必须为"已打包"或"正在处理"

**操作流程：**
1. 验证客户状态
2. 更新客户状态为"部分出货"
3. 记录出货时间
4. 添加状态变更历史记录

### 2.3 标记为未出货 (Mark as Not Shipped)

将已打包的客户标记为未出货状态。

**前提条件：**
- 客户状态必须为"已打包"或"正在处理"

**操作流程：**
1. 验证客户状态
2. 更新客户状态为"未出货"
3. 添加状态变更历史记录

## 3. 状态转换规则

```
[未打包] -> [正在处理] -> [已打包] -> [已出货]
                              |-----> [部分出货]
                              |-----> [未出货]
                              |-----> [已归档] -> [已出货]
                                         |-----> [部分出货]
                                         |-----> [未出货]
```

注意：虽然技术上支持从"已归档"状态进行出货操作，但推荐流程是从"已打包"状态直接出货。

## 4. API 接口

### 4.1 全部出货接口

```
POST /api/customers/:id/ship
```

**请求参数：**
- `id` (路径参数): 客户名称
- `remark` (请求体参数, 可选): 出货备注

**响应：**
```json
{
  "success": true,
  "status": "已出货",
  "shipmentDate": "2023-01-01T10:00:00.000Z",
  "message": "客户出货成功"
}
```

### 4.2 部分出货接口

```
POST /api/customers/:id/partial-ship
```

**请求参数：**
- `id` (路径参数): 客户名称
- `remark` (请求体参数, 可选): 出货备注

**响应：**
```json
{
  "success": true,
  "status": "部分出货",
  "shipmentDate": "2023-01-01T10:00:00.000Z",
  "message": "客户部分出货成功"
}
```

### 4.3 标记为未出货接口

```
POST /api/customers/:id/mark-not-shipped
```

**请求参数：**
- `id` (路径参数): 客户名称
- `remark` (请求体参数, 可选): 备注

**响应：**
```json
{
  "success": true,
  "status": "未出货",
  "message": "客户已标记为未出货"
}
```

## 5. 界面交互

在客户列表界面中，根据客户当前状态显示相应的操作按钮：

- **已打包** 状态客户显示：
  - 归档按钮
  - 出货按钮
  
- **已归档** 状态客户显示：
  - 出货按钮
  - 标记为未出货按钮
  
- **未出货** 状态客户显示：
  - 出货按钮

## 6. 数据结构

出货相关的字段包括：

```json
{
  "status": "已出货",           // 客户状态
  "shipmentDate": "2023-01-01T10:00:00.000Z",  // 出货时间
  "statusHistory": [           // 状态历史记录
    {
      "status": "已出货",
      "previousStatus": "已打包",
      "timestamp": "2023-01-01T10:00:00.000Z",
      "operator": "操作员",
      "remark": "客户出货"
    }
  ]
}
```

## 7. 错误处理

可能出现的错误情况及处理方式：

1. **客户不存在**：
   - 返回404状态码
   - 错误信息："客户不存在"

2. **状态不满足条件**：
   - 返回400状态码
   - 错误信息："只有已打包或正在处理的客户才能进行出货"

3. **系统内部错误**：
   - 返回500状态码
   - 错误信息：具体错误描述

## 8. 注意事项

1. 出货操作是不可逆的，但可以通过标记为未出货来重置状态
2. 出货时间仅在首次出货时记录
3. 状态变更会自动添加到客户的状态历史记录中
4. 推荐在客户打包完成后再进行出货操作，而不是先归档再出货