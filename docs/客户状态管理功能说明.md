# 客户状态管理功能说明

## 功能概述

客户状态管理功能用于跟踪和管理客户数据的打包状态。通过监控packages.json文件的变化，自动更新客户的打包状态，并提供API接口进行状态管理操作。

## 功能特点

1. **自动状态更新**：监控packages.json文件变化，自动更新客户状态
2. **状态历史记录**：记录客户状态变更历史，包括变更时间、操作人员和备注
3. **状态管理API**：提供检查状态、归档、出货等API接口
4. **可视化状态**：不同状态使用不同颜色标识，便于直观查看

## 状态定义

- **未打包**：客户数据已导入，但在packages.json中没有对应的partIDs记录
- **正在处理**：客户数据正在打包过程中，部分partIDs可能已记录在packages.json中
- **已打包**：客户所有数据都已在packages.json中找到对应的partIDs记录
- **已归档**：已打包的客户数据已归档保存
- **已出货**：已归档的客户货物已出货
- **未出货**：已归档的客户货物尚未出货

## 安装和配置

1. 确保已安装Node.js和npm
2. 安装依赖包：
   ```bash
   npm install
   ```

## 使用方法

### 1. 自动状态更新

系统启动时会自动初始化文件监控器，监控packages.json文件的变化。当检测到变化时，系统会自动更新相关客户的状态。

### 2. API接口

#### 检查客户打包状态
```http
POST /api/customers/:id/check-status
```

参数：
- `id`: 客户名称

响应：
```json
{
  "success": true,
  "status": "已打包",
  "packedCount": 100,
  "totalParts": 100,
  "packProgress": 100,
  "packSeqs": ["1", "2", "3"],
  "timestamp": "2023-01-01T10:00:00.000Z"
}
```

#### 归档客户
```http
POST /api/customers/:id/archive
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "已归档",
  "archiveDate": "2023-01-01T10:00:00.000Z",
  "message": "客户归档成功"
}
```

#### 出货客户
```http
POST /api/customers/:id/ship
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "已出货",
  "shipmentDate": "2023-01-01T10:00:00.000Z",
  "message": "客户出货成功"
}
```

#### 标记客户为未出货
```http
POST /api/customers/:id/mark-not-shipped
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "未出货",
  "message": "客户已标记为未出货"
}
```

#### 获取客户状态历史
```http
GET /api/customers/:id/status-history
```

参数：
- `id`: 客户名称

响应：
```json
{
  "success": true,
  "statusHistory": [
    {
      "status": "未打包",
      "timestamp": "2023-01-01T10:00:00.000Z",
      "operator": "系统",
      "remark": "初始状态"
    },
    {
      "status": "已打包",
      "previousStatus": "未打包",
      "timestamp": "2023-01-01T11:00:00.000Z",
      "operator": "系统",
      "remark": "状态从 未打包 变更为 已打包",
      "packProgress": 100,
      "packedParts": 100,
      "totalParts": 100
    }
  ]
}
```

### 3. 测试功能

运行测试脚本验证功能是否正常：
```bash
node src/tests/customer-status-test.js
```

## 实现细节

### 1. 核心模块

- **customer-status-manager.js**: 客户状态管理核心功能
- **enhanced-file-watcher.js**: 增强的文件监控器，用于监控packages.json变化
- **customer-status-api.js**: 客户状态管理API接口

### 2. 状态判断逻辑

状态判断基于以下逻辑：
1. 获取客户所有板件的ID
2. 从packages.json中提取所有partIDs
3. 计算已打包的板件数和打包进度
4. 根据打包进度确定客户状态
5. 获取客户的所有包号

### 3. 文件监控

文件监控器使用两种模式：
- **onChange模式**: 实时监控文件变化，使用fs.watch API
- **onInterval模式**: 定时检查文件变化，使用setInterval

### 4. 状态变更记录

每次状态变更都会记录到状态历史中，包括：
- 状态
- 变更时间
- 操作人员
- 备注
- 打包进度
- 已打包板件数
- 总板件数

## 注意事项

1. 确保packages.json文件格式正确，包含partIDs数组
2. 归档操作只能对已打包的客户执行
3. 出货操作只能对已归档的客户执行
4. 标记为未出货操作只能对已归档的客户执行

## 故障排除

### 1. 文件监控不工作

检查：
- 确保文件路径正确
- 检查文件权限
- 查看日志文件中的错误信息

### 2. 状态更新不正确

检查：
- 确保packages.json文件格式正确
- 检查客户数据是否正确加载
- 查看日志文件中的错误信息

### 3. API调用失败

检查：
- 确保API路径正确
- 检查请求参数是否正确
- 查看日志文件中的错误信息

## 扩展功能

未来可以扩展的功能：
1. 批量状态管理
2. 状态变更通知
3. 打包进度可视化
4. 状态变更预警
5. 自定义报表生成
