# 客户状态管理功能说明

## 功能概述

客户状态管理功能用于跟踪和管理客户数据的打包状态。通过监控packages.json文件的变化，自动更新客户的打包状态，并提供API接口进行状态管理操作。

## 功能特点

1. **自动状态更新**：监控packages.json文件变化，自动更新客户状态
2. **状态历史记录**：记录客户状态变更历史，包括变更时间、操作人员和备注
3. **状态管理API**：提供检查状态、归档、出货等API接口
4. **可视化状态**：不同状态使用不同颜色标识，便于直观查看

## 状态定义

- **未打包**：客户数据已导入，但在packages.json中没有对应的partIDs记录
- **正在处理**：客户数据正在打包过程中，部分partIDs可能已记录在packages.json中
- **已打包**：客户所有数据都已在packages.json中找到对应的partIDs记录
- **已归档**：已打包的客户数据已归档保存
- **已出货**：已打包的客户货物已出货
- **部分出货**：已打包的客户货物部分出货
- **未出货**：已打包的客户货物尚未出货

## 安装和配置

1. 确保已安装Node.js和npm
2. 安装依赖包：
   ```bash
   npm install
   ```

## 使用方法

### 1. 自动状态更新

系统启动时会自动初始化文件监控器，监控packages.json文件的变化。当检测到变化时，系统会自动更新相关客户的状态。

### 2. API接口

#### 检查客户打包状态
```http
POST /api/customers/:id/check-status
```

参数：
- `id`: 客户名称

响应：
```json
{
  "success": true,
  "status": "已打包",
  "packedCount": 100,
  "totalParts": 100,
  "packProgress": 100,
  "packSeqs": ["1", "2", "3"],
  "timestamp": "2023-01-01T10:00:00.000Z"
}
```

#### 归档客户
```http
POST /api/customers/:id/archive
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "已归档",
  "archiveDate": "2023-01-01T10:00:00.000Z",
  "message": "客户归档成功"
}
```

#### 全部出货客户
```http
POST /api/customers/:id/ship
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "已出货",
  "shipmentDate": "2023-01-01T10:00:00.000Z",
  "message": "客户全部出货成功"
}
```

#### 部分出货客户
```http
POST /api/customers/:id/partial-ship
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "部分出货",
  "shipmentDate": "2023-01-01T10:00:00.000Z",
  "message": "客户部分出货成功"
}
```

#### 标记客户为未出货
```http
POST /api/customers/:id/mark-not-shipped
```

参数：
- `id`: 客户名称
- `remark`: 可选，备注信息

响应：
```json
{
  "success": true,
  "status": "未出货",
  "message": "客户已标记为未出货"
}
```

#### 获取客户状态历史
```http
GET /api/customers/:id/status-history
```

参数：
- `id`: 客户名称

响应：
```json
{
  "success": true,
  "statusHistory": [
    {
      "status": "未打包",
      "previousStatus": "初始状态",
      "timestamp": "2023-01-01T09:00:00.000Z",
      "operator": "系统",
      "remark": "状态从未打包变更为正在处理",
      "packProgress": 0,
      "packedParts": 0,
      "totalParts": 100
    },
    {
      "status": "正在处理",
      "previousStatus": "未打包",
      "timestamp": "2023-01-01T09:30:00.000Z",
      "operator": "系统",
      "remark": "状态从正在处理变更为已打包",
      "packProgress": 50,
      "packedParts": 50,
      "totalParts": 100
    },
    {
      "status": "已打包",
      "previousStatus": "正在处理",
      "timestamp": "2023-01-01T10:00:00.000Z",
      "operator": "系统",
      "remark": "状态从已打包变更为已归档",
      "packProgress": 100,
      "packedParts": 100,
      "totalParts": 100
    }
  ]
}
```