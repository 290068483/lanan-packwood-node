# 测试环境使用说明

## 问题描述

之前运行 `npm run test:ui` 命令时，系统使用的是生产环境数据而非测试环境数据，这导致测试环境配置失效。

## 解决方案

修改了 `src/scripts/start-electron.js` 文件，添加了环境初始化逻辑，将 `NODE_ENV=test` 正确映射为 `testing` 环境。

## 修改内容

### 1. 环境映射逻辑

```javascript
// 确定要使用的环境
let targetEnv = 'production'; // 默认环境

if (process.env.NODE_ENV === 'test') {
  targetEnv = 'testing';
  console.log('[ELECTRON] 检测到NODE_ENV=test，映射为testing环境');
} else if (process.env.NODE_ENV === 'development') {
  targetEnv = 'development';
  console.log('[ELECTRON] 使用development环境');
} else if (process.env.NODE_ENV === 'production') {
  targetEnv = 'production';
  console.log('[ELECTRON] 使用production环境');
}
```

### 2. 环境配置加载

```javascript
// 加载环境配置
const config = envManager.loadEnvironment(targetEnv);
console.log(`[ELECTRON] ${config.name}配置加载成功`);

// 初始化数据库连接
const dbConnection = require('../database/connection');
dbConnection.initializeDefaultConnection(targetEnv);
console.log(`[ELECTRON] 数据库连接初始化完成，使用${targetEnv}环境`);
```

## 测试环境配置

测试环境使用 `config/testing.json` 配置文件：

- **环境名称**: 测试环境
- **数据库路径**: `../data-test`
- **基础路径**: `c:/Users/Administrator/Desktop/pack-node-1.0`
- **项目存储**: `C:/Program Files (x86)/MPM/temp/local-test`
- **测试数据**: 包含全客户状态数据，覆盖所有业务场景

## 使用方法

### 1. 启动测试环境 UI

```bash
npm run test:ui
```

### 2. 验证测试环境

运行测试脚本验证配置：

```bash
node src/tests/test-ui-environment.js
```

### 3. 其他环境启动命令

- **开发环境**: `npm run dev`
- **生产环境**: `npm run start` 或 `npm run prod`
- **测试环境**: `npm run test:ui` 或 `npm run test:full`

## 验证步骤

1. 运行 `npm run test:ui` 启动应用
2. 检查控制台输出，应显示：
   ```
   [ELECTRON] 检测到NODE_ENV=test，映射为testing环境
   [ELECTRON] 测试环境配置加载成功
   [ELECTRON] 数据库连接初始化完成，使用testing环境
   ```
3. 确认应用使用的是测试数据（../data-test 路径下的数据）

## 注意事项

- 测试环境使用独立的数据库路径 `../data-test`
- 测试环境包含完整的测试数据，覆盖所有客户状态
- 测试环境启用了调试模式和模拟数据功能
- 测试环境的自动保存路径和生产环境不同，避免数据混淆

## 故障排除

如果测试环境仍然使用生产数据，请检查：

1. `package.json` 中的 `test:ui` 脚本是否正确设置 `NODE_ENV=test`
2. `config/testing.json` 文件是否存在且配置正确
3. `../data-test` 目录是否存在且包含测试数据

## 相关文件

- `src/scripts/start-electron.js` - 主要修改文件
- `config/testing.json` - 测试环境配置
- `src/tests/test-ui-environment.js` - 环境测试脚本
- `src/utils/env-manager.js` - 环境管理器
- `src/database/connection.js` - 数据库连接管理
